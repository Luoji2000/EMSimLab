# 双杆模型（A、B 两导体棒）完整推导与“定时器仿真”实施指导（无摩擦、含外力/碰撞/有界磁场）

> 目标：把我们前面所有关于“双杆模型”的讨论，整理成一套**可直接写进论文**、也**可直接指导仿真实现**的公式体系。  
> 约束：**不写代码**；推导尽量“从定义到结果”逐步展开，不跳步；明确每个公式适用条件；最后给出基于定时器（固定渲染帧率）的仿真流程建议。

---

## 0. 模型与假设（务必先写清）

### 0.1 几何与运动维度
- 两根导体棒 A、B 置于两条平行光滑导轨上；
- 导轨方向取为 **x 轴**（运动是一维：沿 x 方向）；
- 两导体棒长度为 **L**，始终垂直导轨并保持与导轨接触；
- 两棒与导轨构成闭合回路（回路电阻总和为 **R**）。

### 0.2 磁场
- 磁场方向垂直回路平面（沿 z 轴），磁感应强度大小为 **B**；
- **有界磁场**：仅在 x 轴区间 \([x_L, x_R]\) 内存在匀强磁场（B 常量），区外 \(B=0\)。

### 0.3 力学假设
- 不考虑摩擦（导轨光滑；电阻只体现在电路耗能，不作为机械摩擦）；
- 允许对 A、B 施加外力（沿 x 方向），记为 \(F_A, F_B\)；
- \(F_A, F_B\) 可随时间变，但在任何一个“解析推进段”内视为常量（事件驱动分段思想）。

### 0.4 关键“不可穿透”约定
- 约定 **B 在右、A 在左**：始终维持
  \[
  x_B \ge x_A
  \]
- 定义相对间距
  \[
  x \equiv x_B - x_A \ge 0
  \]
- 若预测推进导致 \(x<0\)，则说明本步内发生**碰撞事件**，需要事件定位并应用碰撞映射。

---

## 1. 状态量、派生量与常数

### 1.1 状态量
- 位置与速度：
  \[
  (x_A, v_A),\quad (x_B, v_B)
  \]
- 质量：
  \[
  m_A,\ m_B
  \]
- 外力：
  \[
  F_A,\ F_B
  \]
- 电路与磁场：
  \[
  B,\ L,\ R
  \]

### 1.2 常用组合常数
- 总质量
  \[
  M \equiv m_A + m_B
  \]
- 约化质量
  \[
  \mu \equiv \frac{m_A m_B}{m_A+m_B} = \frac{m_A m_B}{M}
  \]
- 电磁耦合系数（后面会自然出现）
  \[
  k \equiv \frac{B^2 L^2}{R}\quad(\ge 0)
  \]

> 解释：\(k\) 的量纲为 \(\mathrm{N\cdot s/m}\)，在一维模型里表现为“与速度成正比的阻尼系数”，但它来自电磁感应与电阻耗散，而非机械摩擦。

### 1.3 质心/相对变量（强烈推荐使用）
定义质心（center-of-mass）坐标与速度：
\[
x_{cm} \equiv \frac{m_A x_A + m_B x_B}{M},\qquad
v_{cm} \equiv \frac{m_A v_A + m_B v_B}{M}
\]
定义相对坐标与相对速度：
\[
x \equiv x_B - x_A,\qquad
u \equiv v_B - v_A
\]

#### 1.3.1 从 \((x_A,x_B,v_A,v_B)\) 到 \((x_{cm},x,v_{cm},u)\)
这是直接由定义得到的线性变换：
- \(x_{cm}\) 与 \(x\) 按定义计算；
- \(v_{cm}\) 与 \(u\) 按定义计算。

#### 1.3.2 从 \((x_{cm},x,v_{cm},u)\) 还原 \((x_A,x_B,v_A,v_B)\)：逐步推导，不跳步
我们已知两条线性关系：
\[
\begin{cases}
x_{cm} = \dfrac{m_A x_A + m_B x_B}{M}\\[6pt]
x = x_B - x_A
\end{cases}
\]
由第二式得 \(x_B = x_A + x\)，代入第一式：
\[
x_{cm} = \frac{m_A x_A + m_B(x_A+x)}{M}
= \frac{(m_A+m_B)x_A + m_B x}{M}
= \frac{M x_A + m_B x}{M}
\]
因此
\[
x_A = x_{cm} - \frac{m_B}{M}x
\]
再代入 \(x_B=x_A+x\)：
\[
x_B = \left(x_{cm}-\frac{m_B}{M}x\right)+x
= x_{cm} + \left(1-\frac{m_B}{M}\right)x
= x_{cm} + \frac{m_A}{M}x
\]
同理对速度：
\[
\begin{cases}
v_{cm} = \dfrac{m_A v_A + m_B v_B}{M}\\[6pt]
u = v_B - v_A
\end{cases}
\]
由 \(v_B=v_A+u\) 代入：
\[
v_{cm}=\frac{m_A v_A+m_B(v_A+u)}{M}
=\frac{M v_A + m_B u}{M}
\Rightarrow
v_A=v_{cm}-\frac{m_B}{M}u
\]
再得
\[
v_B=v_A+u
=v_{cm}-\frac{m_B}{M}u+u
=v_{cm}+\frac{m_A}{M}u
\]

**结论（后面会频繁使用）**
\[
\boxed{
\begin{aligned}
x_A &= x_{cm}-\frac{m_B}{M}x,&\quad
x_B &= x_{cm}+\frac{m_A}{M}x\\
v_A &= v_{cm}-\frac{m_B}{M}u,&\quad
v_B &= v_{cm}+\frac{m_A}{M}u
\end{aligned}}
\]

---

## 2. 有界磁场的“有效重叠长度”与磁通（核心统一工具）

### 2.1 为什么要引入 \(\ell(x_A,x_B)\)
有界磁场意味着：并不是回路面积 \(A=L(x_B-x_A)\) 的每一部分都在磁场中。  
磁通 \(\Phi\) 只由“回路与磁场区域重叠的那段面积”决定。

因此引入：回路在磁场中的有效长度 \(\ell\)，使得
\[
\Phi = B \cdot (\text{有效面积})
= B \cdot (L\ell)
= BL\,\ell
\]

### 2.2 有效重叠长度 \(\ell\) 的定义（不跳步）
磁场区间为 \([x_L,x_R]\)。回路在 x 方向的跨度为 \([x_A,x_B]\)（假设 \(x_B\ge x_A\)）。

两区间的重叠长度为：
- 重叠右端：\(\min(x_B,x_R)\)
- 重叠左端：\(\max(x_A,x_L)\)

如果右端大于左端，则重叠长度为二者差；否则为 0。于是：
\[
\boxed{
\ell(x_A,x_B)=\max\Big(0,\ \min(x_B,x_R)-\max(x_A,x_L)\Big)
}
\]

### 2.3 磁通与感应电动势
磁通：
\[
\Phi=BL\ell
\]
感应电动势（法拉第定律）：
\[
\varepsilon = -\frac{d\Phi}{dt}=-BL\,\frac{d\ell}{dt}
\]
电流（欧姆定律，回路总电阻 R）：
\[
I=\frac{\varepsilon}{R}=-\frac{BL}{R}\dot{\ell}
\]

### 2.4 关键：\(\dot{\ell}\) 的分段线性结构
在任何一个“模式”（即 A、B 位于磁场区间内外的相对关系固定）中，
\(\ell\) 对 \(x_A,x_B\) 是线性的（或常数），因此：
\[
\dot{\ell}
= \frac{\partial\ell}{\partial x_A}\dot{x}_A+\frac{\partial\ell}{\partial x_B}\dot{x}_B
= \frac{\partial\ell}{\partial x_A}v_A+\frac{\partial\ell}{\partial x_B}v_B
\]
并且
\[
\frac{\partial\ell}{\partial x_A}\in\{0,-1\},\qquad
\frac{\partial\ell}{\partial x_B}\in\{0,1\}
\]
只会在边界事件（穿越 \(x_L,x_R\)）时发生切换。

---

## 3. 用“能量一致性”确定电磁力（避免方向纠结）

### 3.1 电阻耗散功率（严格恒等式）
电阻上耗散功率：
\[
P_R = I^2R
= \left(\frac{BL}{R}\right)^2\dot{\ell}^2\cdot R
= \frac{B^2L^2}{R}\dot{\ell}^2
\]
定义 \(k=\dfrac{B^2L^2}{R}\)，得到：
\[
\boxed{P_R=k\,\dot{\ell}^{\,2}}
\]
这条式子非常重要：**不需要知道电流方向**，功率永远是平方。

### 3.2 机械功率必须等于电阻耗散（能量守恒）
电阻发热来自电磁力对机械系统做的负功（抽取机械能）：
\[
F_{mag,A}v_A + F_{mag,B}v_B = -P_R = -k\dot{\ell}^2
\]
我们希望构造 \(F_{mag,A},F_{mag,B}\)，使上式在每个模式都成立。

### 3.3 一种“通用且最简”的构造（逐步验证）
取：
\[
\boxed{
F_{mag,A}=-k\,\dot{\ell}\,\frac{\partial\ell}{\partial x_A},\qquad
F_{mag,B}=-k\,\dot{\ell}\,\frac{\partial\ell}{\partial x_B}
}
\]
验证机械功率：
\[
F_{mag,A}v_A+F_{mag,B}v_B=-k\dot{\ell}\left(\frac{\partial\ell}{\partial x_A}v_A+\frac{\partial\ell}{\partial x_B}v_B\right)=-k\dot{\ell}\cdot\dot{\ell}=-k\dot{\ell}^2
\]
与所需完全一致。

> 这一步的意义：你无需在每个情形手工判断楞次定律方向；只要 \(\ell\) 的分段表达正确，电磁力就会自动给出“阻碍磁通变化”的效果，并且能量关系严格一致。

---

## 4. 四种核心模式（S0–S3）的定义与方程（完全展开）

我们用 \([x_L,x_R]\) 作为磁场区间。下面给出最常用且足以覆盖教学的大类模式：

### 4.1 模式 S0：无重叠（\(\ell=0\)）或重叠长度为常数（\(\dot\ell=0\)）
- 若 \(\ell=0\)，显然 \(\dot{\ell}=0\)；
- 若两棒跨越整个磁场区（例如 \(x_A<x_L\) 且 \(x_B>x_R\)），则 \(\ell=x_R-x_L\) 为常数，因此 \(\dot\ell=0\)。

因此在 S0：
\[
\dot{\ell}=0\Rightarrow P_R=0,\quad F_{mag,A}=F_{mag,B}=0
\]
动力学方程只剩外力：
\[
m_A\dot v_A = F_A,\qquad m_B\dot v_B = F_B
\]
这是匀加速运动，可解析推进（第 6 节给出离散精确推进式）。

---

### 4.2 模式 S1：只有 A 在场内（B 在右侧场外）
典型几何：\(x_L\le x_A\le x_R < x_B\)

此时回路与磁场的重叠区间为 \([x_A,x_R]\)，长度：
\[
\ell = x_R - x_A
\]
对 \(x_A\) 求偏导：
\[
\frac{\partial\ell}{\partial x_A}=-1,\qquad \frac{\partial\ell}{\partial x_B}=0
\]
因此
\[
\dot\ell = -v_A
\]
电磁力：
\[
F_{mag,A}=-k\dot\ell\frac{\partial\ell}{\partial x_A}
=-k(-v_A)(-1)=-kv_A
\]
\[
F_{mag,B}=0
\]
动力学方程：
\[
m_A\dot v_A = F_A - kv_A,\qquad m_B\dot v_B = F_B
\]
即：A 为“线性阻尼 + 外力”，B 为匀加速。

---

### 4.3 模式 S2：只有 B 在场内（A 在左侧场外）
典型几何：\(x_A<x_L\le x_B\le x_R\)

此时重叠区间为 \([x_L,x_B]\)，长度：
\[
\ell=x_B-x_L
\]
偏导：
\[
\frac{\partial\ell}{\partial x_A}=0,\qquad \frac{\partial\ell}{\partial x_B}=1
\]
因此
\[
\dot\ell=v_B
\]
电磁力：
\[
F_{mag,B}=-k\dot\ell\frac{\partial\ell}{\partial x_B}=-kv_B,\qquad F_{mag,A}=0
\]
动力学方程：
\[
m_A\dot v_A=F_A,\qquad m_B\dot v_B = F_B-kv_B
\]
即：B 阻尼，A 匀加速。

---

### 4.4 模式 S3：两棒都在场内（耦合模式）
典型几何：\(x_L\le x_A\le x_B\le x_R\)

此时重叠长度就是两棒间距：
\[
\ell=x_B-x_A=x
\]
偏导：
\[
\frac{\partial\ell}{\partial x_A}=-1,\qquad \frac{\partial\ell}{\partial x_B}=1
\]
因此
\[
\dot\ell=v_B-v_A=u
\]
电磁力：
\[
F_{mag,A}=-k\dot\ell\frac{\partial\ell}{\partial x_A}=-k u(-1)=+ku
\]
\[
F_{mag,B}=-k\dot\ell\frac{\partial\ell}{\partial x_B}=-k u(1)=-ku
\]
动力学方程：
\[
m_A\dot v_A = F_A + ku,\qquad
m_B\dot v_B = F_B - ku
\]
这是一对“内部耦合力”形式：对 A、B 方向相反，大小与相对速度 u 成正比。

---

## 5. S3 的“质心—相对分解”：完整推导（不跳步）

### 5.1 先写出 S3 的原方程
\[
\begin{cases}
m_A\dot v_A = F_A + k(v_B-v_A)\\
m_B\dot v_B = F_B - k(v_B-v_A)
\end{cases}
\]
即：
\[
\begin{cases}
m_A\dot v_A = F_A + ku\\
m_B\dot v_B = F_B - ku
\end{cases}
\]

### 5.2 推导质心速度方程

质心速度定义：
\[
v_{cm}=\frac{m_A v_A+m_B v_B}{M}
\]
对时间求导：

\[
\dot v_{cm}=\frac{m_A\dot v_A+m_B\dot v_B}{M}
\]
将两条动力学方程分别乘以 1 并相加（等价于代入上式分子）：

\[
m_A\dot v_A+m_B\dot v_B=(F_A+ku)+(F_B-ku)=F_A+F_B
\]
因此
\[
\boxed{\dot v_{cm}=\frac{F_A+F_B}{M}}
\]
**结论：电磁耦合项 \(+ku\) 与 \(-ku\) 相互抵消，所以电磁耦合不影响质心模态。**

### 5.3 推导相对速度方程

相对速度定义：

\[
u=v_B-v_A
\]

对时间求导：

\[
\dot u = \dot v_B-\dot v_A
\]
由原方程解出 \(\dot v_A,\dot v_B\)：

\[
\dot v_A=\frac{F_A+ku}{m_A},\qquad \dot v_B=\frac{F_B-ku}{m_B}
\]

代入：
\[
\dot u=\frac{F_B-ku}{m_B}-\frac{F_A+ku}{m_A}=
\frac{F_B}{m_B}-\frac{F_A}{m_A}
-k\left(\frac{1}{m_B}+\frac{1}{m_A}\right)u
\]
定义

\[
b\equiv \frac{F_B}{m_B}-\frac{F_A}{m_A}
\]
\[
\alpha \equiv k\left(\frac{1}{m_A}+\frac{1}{m_B}\right)
\]
得到标准一阶线性方程：

\[
\boxed{\dot u = b-\alpha u}
\]

### 5.4 把 \(\alpha\) 写成 \(\mu\) 的形式（逐步）

因为
\[
\frac{1}{m_A}+\frac{1}{m_B}=\frac{m_A+m_B}{m_A m_B}=\frac{M}{m_A m_B}
\]
而 \(\mu=\dfrac{m_A m_B}{M}\Rightarrow \dfrac{M}{m_A m_B}=\dfrac{1}{\mu}\)
所以
\[
\alpha = k\cdot \frac{1}{\mu}=\frac{k}{\mu}
\]
即
\[
\boxed{\alpha=\frac{k}{\mu}}
\]

### 5.5 相对位移方程
相对位移 \(x=x_B-x_A\)，对时间求导：
\[
\dot x = \dot x_B-\dot x_A=v_B-v_A=u
\]
因此：
\[
\boxed{\dot x = u}
\]

> 至此，S3 在 \((v_{cm},x_{cm})\) 与 \((u,x)\) 上完全解耦：  
> 质心是匀加速；相对是指数趋于稳态的一阶系统。

---

## 6. 各模式的“解析解”与“离散精确递推”（每段常系数假设下）

下面统一用 \(\tau\) 表示一次解析推进段的持续时间（它可以等于定时器的 \(\Delta t_{sim}\)，也可以是一个事件发生前的子步长）。

### 6.1 匀加速（S0 或某根棒不受电磁力）
方程：
\[
m\dot v = F \Rightarrow \dot v = a,\ a\equiv \frac{F}{m}
\]
积分得到：
\[
v(t+\tau)=v(t)+a\tau
\]
位置：
\[
x(t+\tau)=x(t)+\int_0^\tau v(t+s)\,ds
\]
而 \(v(t+s)=v(t)+as\)，积分：
\[
x(t+\tau)=x(t)+\int_0^\tau (v(t)+as)\,ds
=x(t)+v(t)\tau+\frac12 a\tau^2
\]
因此离散精确递推：
\[
\boxed{
v^+=v+a\tau,\qquad x^+=x+v\tau+\frac12 a\tau^2
}
\]

---

### 6.2 单棒阻尼（S1 中 A；S2 中 B）
标准形式：
\[
m\dot v = F-kv
\Rightarrow
\dot v = \frac{F}{m}-\frac{k}{m}v
\]
定义
\[
\alpha\equiv \frac{k}{m},\qquad v_\infty\equiv \frac{F}{k}\quad(k>0)
\]
则
\[
\dot v = \alpha v_\infty - \alpha v = -\alpha (v-v_\infty)
\]
解（指数衰减）：
\[
v(t+\tau)-v_\infty = (v(t)-v_\infty)e^{-\alpha\tau}
\]
即
\[
\boxed{v^+=v_\infty+(v-v_\infty)e^{-\alpha\tau}}
\]
位置更新：由
\[
x^+=x+\int_0^\tau v(t+s)ds
\]
其中 \(v(t+s)=v_\infty+(v-v_\infty)e^{-\alpha s}\)，积分：
\[
\int_0^\tau v_\infty ds=v_\infty\tau
\]
\[
\int_0^\tau (v-v_\infty)e^{-\alpha s}ds=(v-v_\infty)\left[\frac{1-e^{-\alpha\tau}}{\alpha}\right]
\]
因此
\[
\boxed{
x^+=x+v_\infty\tau+\frac{v-v_\infty}{\alpha}(1-e^{-\alpha\tau})
}
\]

> 退化情形 \(k=0\)：此时不是阻尼，而是匀加速（回到 6.1）。

---

### 6.3 耦合模式 S3：质心 + 相对的离散精确递推

#### 6.3.1 质心部分（匀加速）
\[
\dot v_{cm}=\frac{F_A+F_B}{M}\equiv a_{cm}
\]
因此
\[
\boxed{
v_{cm}^+=v_{cm}+a_{cm}\tau,\qquad
x_{cm}^+=x_{cm}+v_{cm}\tau+\frac12 a_{cm}\tau^2
}
\]

#### 6.3.2 相对部分（指数系统）
相对速度方程：
\[
\dot u=b-\alpha u,\quad b=\frac{F_B}{m_B}-\frac{F_A}{m_A},\quad \alpha=\frac{k}{\mu}
\]
稳态相对速度：
\[
u_\infty=\frac{b}{\alpha}
\]
与单棒阻尼同型，解为：
\[
\boxed{u^+=u_\infty+(u-u_\infty)e^{-\alpha\tau}}
\]
相对位移：
\[
\dot x=u
\Rightarrow
x^+=x+\int_0^\tau u(t+s)ds
\]
而 \(u(t+s)=u_\infty+(u-u_\infty)e^{-\alpha s}\)，积分同前：
\[
\boxed{
x^+=x+u_\infty\tau+\frac{u-u_\infty}{\alpha}(1-e^{-\alpha\tau})
}
\]

#### 6.3.3 还原回 A、B
推进得到 \((x_{cm}^+,v_{cm}^+,x^+,u^+)\) 后，用第 1.3.2 的反解：
\[
\boxed{
\begin{aligned}
x_A &=x_{cm}^-\frac{m_B}{M}x^+,\qquad
x_B &=x_{cm}^++\frac{m_A}{M}x^+\\
v_A &=v_{cm}^-\frac{m_B}{M}u^+,\qquad
v_B &=v_{cm}^++\frac{m_A}{M}u^+
\end{aligned}}
\]

---

## 7. 碰撞事件：瞬时映射与能量损失（完全展开）

### 7.1 碰撞条件
\[
x=x_B-x_A=0
\]
且碰撞前如果 \(u<0\)（B 相对向左追上 A），则可能发生接触。

### 7.2 碰撞模型（恢复系数）
设碰撞瞬间前后速度为 \((v_A^-,v_B^-)\to(v_A^+,v_B^+)\)。

恢复系数定义为相对速度的反弹比例：
\[
\boxed{
v_B^+ - v_A^+ = -\rho (v_B^- - v_A^-)
}
\]
其中 \(0\le\rho\le 1\)。

同时碰撞冲量满足动量守恒（碰撞时间很短，外力冲量忽略）：
\[
\boxed{
m_A v_A^+ + m_B v_B^+ = m_A v_A^- + m_B v_B^-
}
\]

### 7.3 用质心/相对量写碰撞映射（逐步）
定义碰撞前质心速度：
\[
v_{cm}^-=\frac{m_A v_A^- + m_B v_B^-}{M}
\]
动量守恒意味着：
\[
v_{cm}^+=v_{cm}^-
\]
定义相对速度 \(u=v_B-v_A\)，则恢复系数给出：
\[
u^+=-\rho u^-
\]
因此碰撞映射在 \((v_{cm},u)\) 上极简：
\[
\boxed{v_{cm}^+=v_{cm}^-,\qquad u^+=-\rho u^-}
\]
再还原得到：
\[
v_A^+=v_{cm}^+-\frac{m_B}{M}u^+
\]
\[
v_B^+=v_{cm}^++\frac{m_A}{M}u^+
\]

### 7.4 碰撞能量损失（碰撞热，不是焦耳热）
碰撞前后相对动能为：
\[
K_{rel}=\frac12\mu u^2
\]
因为质心动能 \(\frac12 M v_{cm}^2\) 不变（\(v_{cm}\) 不变），能量损失只体现在相对动能上：
\[
Q_{coll}=K_{rel}^- - K_{rel}^+
=\frac12\mu\left[(u^-)^2-(u^+)^2\right]
\]
代入 \(u^+=-\rho u^-\Rightarrow (u^+)^2=\rho^2(u^-)^2\)：
\[
\boxed{
Q_{coll}=\frac12\mu(1-\rho^2)(u^-)^2
}
\]
> 注意：这部分能量转化为形变、声、内能等。它与电阻焦耳热是不同通道，建议仿真中单独记为 \(Q_{coll}\)。

---

## 8. 焦耳热（电阻发热）的递推：推荐用“外力做功 - 动能变化”统一计算

### 8.1 为什么不用复杂的 \( \int v^2 dt \) 展开式
在事件驱动分段系统里，直接对 \(P_R=k\dot\ell^2\) 积分确实可做，但不同模式的表达不同，且有时需要处理指数项，公式会很长。

更稳、更通用的方法：**在无摩擦条件下，外力做功 = 动能变化 + 电阻发热（焦耳热）**  
因此对任一解析推进段 \([t,t+\tau]\)：
\[
W_{ext} = \Delta K_{mech} + \Delta Q_R
\Rightarrow
\Delta Q_R = W_{ext} - \Delta K_{mech}
\]

### 8.2 外力做功（逐步写出）
外力对每根棒做功为力乘位移：
\[
W_{ext}=F_A(x_A^+-x_A)+F_B(x_B^+-x_B)
\]

### 8.3 动能变化（逐步写出）
总动能：
\[
K=\frac12 m_A v_A^2+\frac12 m_B v_B^2
\]
因此
\[
\Delta K = \frac12 m_A[(v_A^+)^2-v_A^2]+\frac12 m_B[(v_B^+)^2-v_B^2]
\]

### 8.4 焦耳热递推式
定义累计焦耳热 \(Q_R\)，则
\[
\boxed{
Q_R^+ = Q_R + F_A(x_A^+-x_A)+F_B(x_B^+-x_B) - \Delta K
}
\]
该式对 S0/S1/S2/S3 全部成立，只要这一段没有把碰撞能量当作焦耳热混进去。

> 建议：  
> - 连续推进段：用上式累加到 \(Q_R\)；  
> - 碰撞瞬间：用第 7.4 的 \(Q_{coll}\) 单独累加，不混入 \(Q_R\)。

---

## 9. 事件集合与“模式切换”（这是仿真正确性的关键）

### 9.1 事件类型总表
在无摩擦双杆模型中，最重要的事件只有两类：

1) **碰撞事件**：  
\[
x(t)=x_B(t)-x_A(t)=0
\]

2) **磁场边界事件（导致模式切换）**：  
A、B 各自穿越磁场边界：
\[
x_A(t)=x_L,\quad x_A(t)=x_R,\quad x_B(t)=x_L,\quad x_B(t)=x_R
\]

> 只要你能在每一步中找到“最早发生的事件”，就可以把系统分段成若干个“常系数解析推进段”。

### 9.2 “当前模式”的判定（用 \(\ell\) 最稳）
给定当前 \(x_A,x_B\)，先算
\[
\ell=\max\Big(0,\ \min(x_B,x_R)-\max(x_A,x_L)\Big)
\]
- 若 \(\ell=0\)：S0（\(\dot\ell=0\)，无电磁力）
- 若 \(x_L\le x_A\le x_R\) 且 \(x_B>x_R\)：S1（仅 A 阻尼）
- 若 \(x_A<x_L\) 且 \(x_L\le x_B\le x_R\)：S2（仅 B 阻尼）
- 若 \(x_L\le x_A\le x_B\le x_R\)：S3（耦合阻尼）

边界附近要用容差避免抖动（见第 11 节）。

---

## 10. 事件时间能否“完全解析”？如何在工程上处理

### 10.1 结论（与你的直觉一致）
- 在很多组合下，事件时间方程会变成“多项式 + 指数项”的超越方程；
- 一般不存在漂亮的初等闭式；
- 用 Lambert W 可以写出一部分特殊情形的闭式，但对工程实现并不必要（也会让论文难读）。

### 10.2 工程上推荐策略（保持“高精度”且实现简单）
- 每个模式内你都有 **解析表达** 的 \(x_A(t),x_B(t)\)（匀加速或指数衰减），因此事件方程 \(f(t)=0\) 可写成可计算函数；
- 用**可靠的求根法**在区间 \([0,\tau]\) 内定位事件时刻：
  - 先用“端点检查”判断是否发生（符号变化或越界）；
  - 若发生，用**二分法**保证收敛（稳定），再可选叠加 1–2 次牛顿法加速（可选）。

> 这满足你要的“尽可能精确”：误差主要来自浮点与求根容差，几乎可做到机器精度；不需要复杂函数论/留数定理。

---

## 11. 定时器仿真（Timer-driven）实施指导：把物理推进与渲染分离

这一节是你项目规则的核心：**渲染帧率固定，speed 只改变仿真时间推进量**。

### 11.1 两个时间尺度（必须区分）
1) **渲染时间步长** \(\Delta t_{render}\)  
- 由定时器周期决定（建议 20–30 Hz）
- 只用于刷新动画与曲线显示  
- 不应被 speed 改变

2) **仿真时间步长** \(\Delta t_{sim}\)  
- 每次 tick 内物理推进的总时长  
- 由 speed 改变：
  \[
  \Delta t_{sim} = \text{speed}\times \Delta t_{base}
  \]
- \(\Delta t_{base}\) 通常取 \(\Delta t_{render}\) 或其某个固定比例

### 11.2 单次 tick 内的“子步循环”（事件驱动）
每次定时器 tick 到来：
- 你有一段仿真时长预算 \(\Delta t_{sim}\)
- 但期间可能发生 0 次、1 次或多次事件（边界/碰撞）
- 因此把 \(\Delta t_{sim}\) 切分为若干段 \(\tau_1,\tau_2,\dots\)，每段都落在同一模式内且不跨事件

建议流程（文字版，不写代码）：

1. 设剩余时间 \(T \leftarrow \Delta t_{sim}\)
2. while \(T>0\)：
   1) 根据当前 \(x_A,x_B\) 判定模式 S0/S1/S2/S3  
   2) 假设在接下来 \(T\) 内不发生事件，用对应模式的解析递推公式得到“预测末态”  
   3) 用预测结果检查是否发生：
      - 碰撞：预测 \(x^+<0\)（或 \(x\) 从正变负）  
      - 边界：预测某个 \(x_A\) 或 \(x_B\) 越过 \(x_L\) 或 \(x_R\)
   4) 若无事件：
      - 接受这段推进，更新状态
      - \(T\leftarrow 0\)（本 tick 结束）
   5) 若有事件：
      - 计算所有候选事件的发生时间 \(t_e\in(0,T]\)（求根/定位）
      - 取最早事件 \(t_{min}\)
      - 先推进 \(\tau=t_{min}\)（用解析递推）
      - 执行事件：
        - 若碰撞：应用第 7 节碰撞映射（并累加 \(Q_{coll}\)）
        - 若边界：更新模式（下一轮循环自然会切换）
      - \(T\leftarrow T-t_{min}\)，继续 while

> 这样做的好处：  
> - 物理推进每段都是解析式，**无积分截断误差**；  
> - 事件定位可做到高精度；  
> - 渲染频率固定，速度只改变推进总时长，符合你的项目规则。

### 11.3 曲线输出与“关键物理量动态展示”
你项目硬性要求至少展示 \(|v|(t)\)、\(|a|(t)\)；双杆还推荐展示 \(\varepsilon(t),I(t),P(t)\) 等。  
在双杆模型中建议输出：

- 单棒速度：
  \[
  |v_A|(t),\ |v_B|(t)
  \]
- 单棒加速度（每段内可直接由方程给出）：
  - S0：\(a_A=F_A/m_A,\ a_B=F_B/m_B\)
  - S1：\(a_A=(F_A-kv_A)/m_A,\ a_B=F_B/m_B\)
  - S2：\(a_A=F_A/m_A,\ a_B=(F_B-kv_B)/m_B\)
  - S3：\(a_A=(F_A+ku)/m_A,\ a_B=(F_B-ku)/m_B\)
- 有界磁场关键量：
  \[
  \ell(t),\ \dot\ell(t),\ \varepsilon(t)=-BL\dot\ell,\ I(t)=\varepsilon/R,\ P_R(t)=k\dot\ell^2
  \]
- 热量：
  \[
  Q_R(t)\ \text{（焦耳热累计）},\quad Q_{coll}(t)\ \text{（碰撞热累计，可选）}
  \]

### 11.4 数值稳定性建议（不写代码但给原则）
- 计算 \(1-e^{-\alpha\tau}\) 时，\(\alpha\tau\) 很小时容易损失精度；建议使用“指数差函数思想”（例如数学上用 \(\mathrm{expm1}\) 等价方式），或在论文里注明可用泰勒：
  \[
  1-e^{-z}=z-\frac{z^2}{2}+\frac{z^3}{6}-\cdots,\quad z=\alpha\tau
  \]
- 边界比较用容差 \(\epsilon\)：
  - 判定“在场内”：用 \(x_L-\epsilon \le x \le x_R+\epsilon\)
  - 防止数值抖动导致模式来回切换
- 碰撞后强制设置 \(x\leftarrow 0\)，并确保 \(x_B\ge x_A\)

---

## 12. 自检（验证物理正确性的“守恒量/一致性”）

### 12.1 动量（无外力时）
若 \(F_A=F_B=0\) 且无碰撞外冲量：
\[
P=m_A v_A+m_B v_B = M v_{cm}
\]
在 S3 内电磁力内力相消，因此应守恒。

### 12.2 能量账（无摩擦）
连续推进段内应满足：
\[
W_{ext} = \Delta K + \Delta Q_R
\]
碰撞瞬间（若 \(\rho<1\)）还应有：
\[
\Delta K_{coll} = -Q_{coll}
\]
总能量账可写为（外力做功 = 动能变化 + 焦耳热 + 碰撞热）：
\[
W_{ext} = \Delta K + \Delta Q_R + Q_{coll}
\]
这条非常适合做调试打印/验证曲线。

---

## 13. 总结（把“复杂问题”压成三块简单模块）

你可以把整个双杆系统的实现/论文叙事压缩为三块：

1) **模式内解析推进**：只需三类解析器  
- 匀加速（S0/未受磁）  
- 单棒阻尼（S1/S2）  
- 双棒耦合（S3，用质心-相对解耦）

2) **事件**：只两类  
- 碰撞：\((v_{cm},u)\) 瞬时映射（恢复系数）  
- 边界：模式切换（由 \(\ell\) 判定）

3) **能量与热量**：统一递推  
- 焦耳热：\(\Delta Q_R=W_{ext}-\Delta K\)  
- 碰撞热（可选）：\(Q_{coll}=\tfrac12\mu(1-\rho^2)(u^-)^2\)

---

## 14. 附：四模式下 \(\dot\ell\) 与功率的对照表（教学很有用）

| 模式 | 典型条件 | \(\ell\) | \(\dot\ell\) | \(P_R=k\dot\ell^2\) |
|---|---|---|---|---|
| S0 | 无重叠或 \(\ell\) 常数 | 0 或常数 | 0 | 0 |
| S1 | \(x_L\le x_A\le x_R < x_B\) | \(x_R-x_A\) | \(-v_A\) | \(k v_A^2\) |
| S2 | \(x_A<x_L\le x_B\le x_R\) | \(x_B-x_L\) | \(v_B\) | \(k v_B^2\) |
| S3 | \(x_L\le x_A\le x_B\le x_R\) | \(x_B-x_A\) | \(u=v_B-v_A\) | \(k u^2\) |

---

> 到这里，这份 MD 文档已经把：  
> - 双杆模型（含外力）  
> - 有界磁场统一处理（\(\ell\)）  
> - S0–S3 模式方程与解析递推  
> - 碰撞瞬时映射与能量损失  
> - 焦耳热统一递推  
> - 定时器仿真（固定渲染 Hz、speed 只影响 \(\Delta t_{sim}\)、事件驱动子步循环）  
> 全部系统化整理完毕，且推导过程逐步展开、尽量不省略。

如果你接下来要把它放进论文，我建议你在“方法章节”里按 **(1) 统一 \(\ell\) → (2) 能量一致性给出 \(F_{mag}\) → (3) S0–S3 分段解析 → (4) 事件驱动拼接** 的顺序组织，会非常清晰。
