# 速度选择器（匀强 **E** + 匀强 **B**）的解析递推笔记（无截断误差）

> 目标：在不考虑重力、场在每个“模式”里均匀且恒定的前提下，把带电粒子在复合场中的运动写成**一步 Δt 的解析递推公式**（只剩浮点误差），并解释两种推法为何得到同一个递推。

---

## 0. 几何设定与符号（本笔记默认的坐标约定）

- 纸面为 **x–y** 平面  
- **x**：向右（粒子初速度方向）  
- **y**：向上（电场方向只能上下）  
- **z**：垂直纸面（磁场方向只能入/出纸面）

设  
\[
\mathbf E=(0,E_y,0),\qquad \mathbf B=(0,0,B_z)
\]
其中：
- \(E_y>0\) 表示电场向上，\(E_y<0\) 向下  
- \(B_z>0\) 表示磁场出纸面，\(B_z<0\) 入纸面  

粒子电荷 \(q\)、质量 \(m\)。忽略重力。

---

## 1. 从洛伦兹力到“线性/仿射常系数方程”

洛伦兹方程：
\[
m\dot{\mathbf v}=q(\mathbf E+\mathbf v\times \mathbf B)
\]

### 1.1 叉乘算子是线性的，所以能写成矩阵
对固定的 \(\mathbf B\)，映射 \(\mathbf v\mapsto \mathbf v\times\mathbf B\) 对 \(\mathbf v\) **线性**，因此存在矩阵 \([\,\mathbf B\times\,]\) 使得
\[
[\,\mathbf B\times\,]\mathbf v=\mathbf v\times\mathbf B
\]

推导：令  
\[
\mathbf v=\begin{bmatrix}v_x\\v_y\\v_z\end{bmatrix},\quad
\mathbf B=\begin{bmatrix}B_x\\B_y\\B_z\end{bmatrix}
\]
叉乘展开：
\[
\mathbf v\times \mathbf B=
\begin{bmatrix}
v_yB_z-v_zB_y\\
v_zB_x-v_xB_z\\
v_xB_y-v_yB_x
\end{bmatrix}
\]
按 \((v_x,v_y,v_z)\) 收系数得到：
\[
\boxed{
[\,\mathbf B\times\,]=
\begin{bmatrix}
0 & B_z & -B_y\\
-B_z & 0 & B_x\\
B_y & -B_x & 0
\end{bmatrix}}
\]
（这是一个反对称矩阵。）

当 \(\mathbf B=(0,0,B_z)\) 时，在 x–y 平面限制为
\[
[\,\mathbf B\times\,]_{xy}=B_z
\underbrace{\begin{bmatrix}0&1\\-1&0\end{bmatrix}}_{J}
=B_zJ
\]

### 1.2 加上电场仍然不是非线性
将方程改写为
\[
\dot{\mathbf v}=A\mathbf v+\mathbf b,\qquad
A=\frac{q}{m}[\,\mathbf B\times\,],\quad
\mathbf b=\frac{q}{m}\mathbf E
\]
这是**常系数非齐次线性系统**（也叫仿射 ODE），不是非线性。

---

## 2. 两条求解路线（最终会得到同一个递推）

### 路线 A：平移变量（找定点/漂移速度）
若存在常向量 \(\mathbf v_d\) 满足
\[
A\mathbf v_d+\mathbf b=0
\]
则令 \(\mathbf w=\mathbf v-\mathbf v_d\)，可得齐次系统
\[
\dot{\mathbf w}=A\mathbf w
\]
因此一步精确推进为
\[
\boxed{\mathbf w_{n+1}=e^{A\Delta t}\mathbf w_n}
\]
还原回 \(\mathbf v\) 得
\[
\boxed{\mathbf v_{n+1}=\mathbf v_d+e^{A\Delta t}(\mathbf v_n-\mathbf v_d)}
\]

### 路线 B：通解（积分因子/变参数）
标准通解（永远成立，不需要 \(A^{-1}\)）：
\[
\boxed{
\mathbf v_{n+1}=e^{A\Delta t}\mathbf v_n+\int_0^{\Delta t}e^{A(\Delta t-s)}\mathbf b\,ds}
\]

> 注意：在 3D 全空间，叉乘矩阵通常不可逆（例如 \([\,\mathbf B\times\,]\mathbf B=0\)），因此不应盲目使用 \(A^{-1}(e^{A\Delta t}-I)\mathbf b\) 的形式；积分形式永远安全。

### 2.1 两条路线如何变成同一个递推？

若 \(\mathbf v_d\) 存在且 \(\mathbf b=-A\mathbf v_d\)，则

\[
\int_0^{\Delta t}e^{A(\Delta t-s)}\mathbf b\,ds=
\int_0^{\Delta t}e^{A(\Delta t-s)}(-A\mathbf v_d)\,ds
\]

利用恒等式

\[
\frac{d}{ds}\left(e^{A(\Delta t-s)}\right)=-Ae^{A(\Delta t-s)}
\]
可得

\[
e^{A(\Delta t-s)}(-A\mathbf v_d)=\frac{d}{ds}\left(e^{A(\Delta t-s)}\right)\mathbf v_d
\]

因此积分直接变成边界项：

\[
\int_0^{\Delta t}\frac{d}{ds}\left(e^{A(\Delta t-s)}\right)\mathbf v_d\,ds=\left[e^{A(\Delta t-s)}\mathbf v_d\right]_{0}^{\Delta t}
=\mathbf v_d-e^{A\Delta t}\mathbf v_d
\]

代回路线 B：

\[
\mathbf v_{n+1}=e^{A\Delta t}\mathbf v_n+\mathbf v_d-e^{A\Delta t}\mathbf v_d=
\boxed{\mathbf v_d+e^{A\Delta t}(\mathbf v_n-\mathbf v_d)}
\]
与路线 A 完全一致。

---

## 3. 回到速度选择器几何：显式写出 \(e^{A\Delta t}\)

现在取
\[
\mathbf B=(0,0,B_z),\quad \mathbf E=(0,E_y,0),\quad \mathbf v=(v_x,v_y)
\]
定义带符号回旋频率与步进角：
\[
\boxed{\omega=\frac{qB_z}{m}},\qquad \boxed{\theta=\omega\Delta t}
\]
此时二维矩阵
\[
A=\omega
\begin{bmatrix}0&1\\-1&0\end{bmatrix}
=\omega J
\]
并且
\[
e^{A\Delta t}=e^{\omega J\Delta t}=R(\theta)
\]
其中（与微分方程 \(\dot w_x=\omega w_y,\dot w_y=-\omega w_x\) 相匹配的旋转矩阵）
\[
\boxed{
R(\theta)=
\begin{bmatrix}
\cos\theta & \sin\theta\\
-\sin\theta & \cos\theta
\end{bmatrix}}
\]

---

## 4. 漂移速度（定点/特解）与“速度选择器条件”

解定点方程 \(A\mathbf v_d+\mathbf b=0\)。

在分量方程里：
\[
\dot v_x=\omega v_y,\qquad \dot v_y=\frac{q}{m}E_y-\omega v_x
\]
定点要求 \(\dot v_x=\dot v_y=0\)，因此 \(v_y=0\) 且
\[
0=\frac{q}{m}E_y-\omega v_x
\Rightarrow
v_x=\frac{E_y}{B_z}
\]
所以
\[
\boxed{\mathbf v_d=\left(\frac{E_y}{B_z},\,0\right)\equiv (v_d,0)}
\]

**速度选择器通过条件（不偏转直线穿过）**：
\[
\boxed{v_{y,0}=0,\quad v_{x,0}=v_d=\frac{E_y}{B_z}}
\]
此时 \(\mathbf v(t)\equiv \mathbf v_d\)。

---

## 5. 速度的一步解析递推（核心）

定义相对速度：
\[
\mathbf w=\mathbf v-\mathbf v_d=(w_x,w_y)=(v_x-v_d,\;v_y)
\]
则
\[
\boxed{\mathbf w_{n+1}=R(\theta)\mathbf w_n}
\]
还原速度：
\[
\boxed{\mathbf v_{n+1}=\mathbf v_d+\mathbf w_{n+1}}
\]

写成分量（便于实现）：
\[
\boxed{
v_{x,n+1}=v_d+\cos\theta\,(v_{x,n}-v_d)+\sin\theta\,v_{y,n}}
\]
\[
\boxed{
v_{y,n+1}=-\sin\theta\,(v_{x,n}-v_d)+\cos\theta\,v_{y,n}}
\]
其中 \(\theta=\omega\Delta t=\dfrac{qB_z}{m}\Delta t\)，\(v_d=\dfrac{E_y}{B_z}\)。  
> 方向（入/出纸面、向上/向下、正负电荷）统一由 \(\omega\) 与 \(v_d\) 的符号自动决定。

---

## 6. 位移的一步解析递推（两种等价形式）

位置满足 \(\dot{\mathbf r}=\mathbf v=\mathbf v_d+\mathbf w\)。一步推进：
\[
\mathbf r_{n+1}=\mathbf r_n+\mathbf v_d\Delta t+\int_0^{\Delta t}\mathbf w(t_n+\tau)\,d\tau
\]
而 \(\mathbf w(t_n+\tau)=R(\omega\tau)\mathbf w_n\)。

### 形式 A：显式 \(\sin/\cos\)（直接积分）

\[
\int_0^{\Delta t}R(\omega\tau)\,d\tau=\frac1\omega
\begin{bmatrix}
\sin\theta & 1-\cos\theta\\
-(1-\cos\theta) & \sin\theta
\end{bmatrix}
\]

所以

\[
\boxed{
\mathbf r_{n+1}=
\mathbf r_n+\mathbf v_d\Delta t
+\frac1\omega
\begin{bmatrix}
\sin\theta & 1-\cos\theta\\
-(1-\cos\theta) & \sin\theta
\end{bmatrix}
\mathbf w_n}
\]

分量形式：
\[
\boxed{
x_{n+1}=x_n+v_d\Delta t+\frac{\sin\theta}{\omega}w_{x,n}+\frac{1-\cos\theta}{\omega}w_{y,n}}
\]
\[
\boxed{
y_{n+1}=y_n-\frac{1-\cos\theta}{\omega}w_{x,n}+\frac{\sin\theta}{\omega}w_{y,n}}
\]
并且 \(w_{x,n}=v_{x,n}-v_d,\;w_{y,n}=v_{y,n}\)。

---

### 形式 B：只用 \(\mathbf w_{n+1}-\mathbf w_n\)（更“递推”）
因为 \(\dot{\mathbf w}=A\mathbf w\)，且在二维 \(A=\omega J\) 可逆（\(\omega\neq0\)）：
\[
\int_0^{\Delta t}e^{A\tau}d\tau = A^{-1}(e^{A\Delta t}-I)
\]
乘上 \(\mathbf w_n\) 且 \(e^{A\Delta t}\mathbf w_n=\mathbf w_{n+1}\)，得
\[
\int_0^{\Delta t}\mathbf w(t_n+\tau)d\tau = A^{-1}(\mathbf w_{n+1}-\mathbf w_n)
\]
于是
\[
\boxed{
\mathbf r_{n+1}=\mathbf r_n+\mathbf v_d\Delta t+A^{-1}(\mathbf w_{n+1}-\mathbf w_n)}
\]
又因
\[
A^{-1}=\frac1\omega
\begin{bmatrix}0&-1\\1&0\end{bmatrix}
\]
得到简洁的分量递推：
\[
\boxed{
x_{n+1}=x_n+v_d\Delta t-\frac{w_{y,n+1}-w_{y,n}}{\omega}}
\]
\[
\boxed{
y_{n+1}=y_n+\frac{w_{x,n+1}-w_{x,n}}{\omega}}
\]

> 形式 A 与形式 B 严格等价：A 是直接做 \(\sin/\cos\) 积分，B 是用矩阵恒等式把积分改写成“端点差”。

---

## 7. 退化情况与数值实现注意点

### 7.1 \(B_z=0\)（纯电场）
此时 \(\omega=0\)，不应使用上面的旋转/除 \(\omega\) 公式。直接用：
\[
v_{x,n+1}=v_{x,n},\quad
v_{y,n+1}=v_{y,n}+\frac{qE_y}{m}\Delta t
\]
\[
x_{n+1}=x_n+v_{x,n}\Delta t,\quad
y_{n+1}=y_n+v_{y,n}\Delta t+\frac12\frac{qE_y}{m}\Delta t^2
\]

### 7.2 \(\omega\to0\)（弱磁场或超小步长）
形式 A 中出现 \(\frac{\sin\theta}{\omega}\)、\(\frac{1-\cos\theta}{\omega}\) 的 \(0/0\) 风险。用稳定写法：
\[
\frac{\sin\theta}{\omega}=\Delta t\cdot\frac{\sin\theta}{\theta},\qquad
\frac{1-\cos\theta}{\omega}=\Delta t\cdot\frac{1-\cos\theta}{\theta}
\]
并用泰勒展开（\(\theta\) 很小时）：
\[
\frac{\sin\theta}{\theta}\approx 1-\frac{\theta^2}{6},\qquad
\frac{1-\cos\theta}{\theta}\approx \frac{\theta}{2}-\frac{\theta^3}{24}
\]

---

## 8. 一套最简“无截断误差”更新流程（可直接实现）

给定状态 \((x_n,y_n,v_{x,n},v_{y,n})\)、步长 \(\Delta t\)：

1. 计算  
   \[
   \omega=\frac{qB_z}{m},\quad \theta=\omega\Delta t
   \]
   若 \(B_z=0\) 走纯电场分支。

2. 漂移速度  
   \[
   v_d=\frac{E_y}{B_z},\quad \mathbf v_d=(v_d,0)
   \]

3. 相对速度  
   \[
   w_{x,n}=v_{x,n}-v_d,\quad w_{y,n}=v_{y,n}
   \]

4. 旋转更新（精确）  
   \[
   \begin{bmatrix}w_{x,n+1}\\w_{y,n+1}\end{bmatrix}=
   \begin{bmatrix}
   \cos\theta & \sin\theta\\
   -\sin\theta & \cos\theta
   \end{bmatrix}
   \begin{bmatrix}w_{x,n}\\w_{y,n}\end{bmatrix}
   \]

5. 还原速度  
   \[
   v_{x,n+1}=v_d+w_{x,n+1},\quad v_{y,n+1}=w_{y,n+1}
   \]

6. 更新位置（任选其一）
   - **形式 A**（用 \(\sin,\cos\)）：
     \[
     x_{n+1}=x_n+v_d\Delta t+\frac{\sin\theta}{\omega}w_{x,n}+\frac{1-\cos\theta}{\omega}w_{y,n}
     \]
     \[
     y_{n+1}=y_n-\frac{1-\cos\theta}{\omega}w_{x,n}+\frac{\sin\theta}{\omega}w_{y,n}
     \]
   - **形式 B**（用端点差）：
     \[
     x_{n+1}=x_n+v_d\Delta t-\frac{w_{y,n+1}-w_{y,n}}{\omega}
     \]
     \[
     y_{n+1}=y_n+\frac{w_{x,n+1}-w_{x,n}}{\omega}
     \]

---

## 9. 一句话理解（帮助记忆）

在匀强 **E** + 匀强 **B** 下（且 \(\mathbf E\perp\mathbf B\)），粒子的速度可以理解为：

- **整体以 \(\mathbf v_d\) 匀速漂移**（这里沿 x，大小 \(E_y/B_z\)）
- 同时叠加一个**绕 \(\mathbf v_d\) 的匀速旋转分量** \(\mathbf w\)

因此最自然、最稳定的“无截断误差”更新就是：
\[
\boxed{\mathbf v_{n+1}=\mathbf v_d+R(\theta)(\mathbf v_n-\mathbf v_d)}
\]
并对位置做一次同样精确的积分更新。
