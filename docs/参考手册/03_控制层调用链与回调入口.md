# 控制层调用链与回调入口

本文回答三个问题：

1. UI 事件从哪里进来？
2. 每个入口函数做什么、改了什么数据？
3. 新增一个按钮或事件时，应该放在哪里？

快速跳转：

1. 上一页：`02_模板扩展主线.md`
2. 下一页：`04_引擎与物理核扩展.md`
3. 术语表：`GLOSSARY.md`

## 1. 控制层在项目里的位置

目录：`src/+control/`  
它是 UI 与引擎之间的调度层，不负责写具体物理公式。

当前主要入口文件：

1. `onTemplateChanged.m`
2. `onParamsChanged.m`
3. `onPlay.m`
4. `onPause.m`
5. `onTick.m`
6. `onReset.m`
7. `parseTemplateId.m`
8. `mergeRailOutputs.m`

## 2. UI 回调如何绑定到控制层

绑定位置：`apps/MainApp.m` 的 `bindUiCallbacks`。

对应关系：

1. `TemplateTree.SelectionChangedFcn -> control.onTemplateChanged`
2. `PlayButton.ButtonPushedFcn -> control.onPlay`
3. `PauseButton.ButtonPushedFcn -> control.onPause`
4. `ResetButton.ButtonPushedFcn -> control.onReset`
5. 定时器 `TimerFcn -> control.onTick`
6. 参数组件事件 `PayloadChanged -> control.onParamsChanged`

## 3. 五条核心调用链（最常用）

### 3.1 模板切换链

入口：`control.onTemplateChanged`

主流程：

1. `control.parseTemplateId` 解析模板 token。
2. `templates.getById` 读取模板定义。
3. `params.schema_get/defaults/validate` 生成合法参数。
4. `templates.applyTemplatePreset` 应用模板预设。
5. `engine.reset` 重置状态。
6. `app.reloadParamComponent` 重载参数组件。
7. `ui.applyPayload + ui.render` 刷新界面。

### 3.2 改参链

入口：`control.onParamsChanged`

主流程：

1. `ui.buildPayload` 采集参数。
2. `params.validate` 统一校验与联动。
3. `ui.applyPayload` 回写控件显示。
4. `engine.reset` 重置状态（当前策略是改参即重置）。
5. `control.mergeRailOutputs` 合并输出字段。
6. `ui.applyOutputs + ui.render` 刷新输出与画面。

### 3.3 播放链

入口：`control.onPlay`

主流程：

1. 优先走 `app.startPlayback()` 启动定时器。
2. 定时器每帧调用 `control.onTick`。
3. `onTick` 内执行 `engine.step -> mergeRailOutputs -> applyOutputs -> render`。

### 3.4 暂停链

入口：`control.onPause`

主流程：

1. 调 `app.pausePlayback()` 停定时器。
2. 不改参数，不重置状态。

### 3.5 重置链

入口：`control.onReset`

主流程：

1. 若在播放先暂停。
2. `engine.reset` 回初始状态。
3. `mergeRailOutputs -> applyOutputs -> render`。

## 4. `params` 与 `state` 在控制层怎么流动

控制层常见读写约定：

1. `app.Params`：当前合法参数。
2. `app.State`：当前仿真状态。
3. 任何 UI 输入先过 `params.validate` 再进引擎。
4. 任何引擎输出先过 `mergeRailOutputs` 再回写 UI 输出区。

## 5. 关键辅助函数说明

### 5.1 `parseTemplateId`

文件：`src/+control/parseTemplateId.m`  
作用：兼容不同 MATLAB 回调参数形态（字符串、树节点、事件对象）。

### 5.2 `mergeRailOutputs`

文件：`src/+control/mergeRailOutputs.m`  
作用：把 `state` 中的输出字段同步回 `params`，方便组件输出区显示。

### 5.3 `onTick` 的子步进

文件：`src/+control/onTick.m`  
作用：一帧内可拆多个物理子步，减少运动“跳点感”。

## 6. 新增一个回调功能的推荐做法

示例：你要新增“单步按钮（StepOnce）”。

推荐步骤：

1. 在 `apps/MainApp.m` 新增按钮控件与 `ButtonPushedFcn` 绑定。
2. 在 `src/+control/` 新建 `onStepOnce.m`。
3. 在 `onStepOnce.m` 里复用现有链路：
   1. 调 `engine.step`
   2. 调 `mergeRailOutputs`
   3. 调 `ui.applyOutputs`
   4. 调 `ui.render`
4. 仅在控制层调度，不把公式写进 `MainApp.m`。

## 7. 常见坑

1. 在 UI 回调里直接改状态，跳过 `validate`，会造成参数语义不一致。
2. 播放中切模板没先暂停，可能出现并发推进（当前 `onTemplateChanged` 已处理）。
3. 新增输出字段后忘记改 `mergeRailOutputs`，导致输出区看不到数据。
4. 只改 `onPlay` 不改 `onTick`，通常无法实现稳定播放逻辑。

## 8. 新手练习

1. 把 `onParamsChanged` 的“参数变化摘要”日志关键信息读一遍，确认每次改参都会落日志。
2. 在 `onReset` 增加一个自定义信息日志，确认按钮点击时能看到。
3. 跟踪一次完整播放：`onPlay -> onTick -> onPause`，记录 `app.State.t` 变化。

图示占位：

1. [占位] 回调绑定总览图（MainApp -> control）
2. [占位] onTick 每帧时序图
