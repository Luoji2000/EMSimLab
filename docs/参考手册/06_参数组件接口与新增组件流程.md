# 参数组件接口与新增组件流程

本文专门讲 `m/*_for_test.m` 这一层。  
这是模板扩展里最容易“看起来能跑、实际上不稳定”的地方。

快速跳转：

1. 上一页：`05_UI渲染与日志排错.md`
2. 下一页：`07_发布与日常开发协作.md`
3. 术语表：`GLOSSARY.md`

## 1. 参数组件是什么

参数组件是 `matlab.ui.componentcontainer.ComponentContainer` 子类，用来承接模板参数 UI。  
当前代表文件：

1. `m/M1_for_test.m`
2. `m/M4_for_test.m`
3. `m/M5_for_test.m`
4. `m/R2_for_test.m`

## 2. 当前项目的最小接口契约

从 `src/+ui/buildPayload.m` 与 `src/+ui/applyPayload.m` 可见，项目默认查找这些接口：

1. `getPayload()`
2. `setPayload(payload)`
3. 事件：`PayloadChanged`

从 `src/+ui/applyOutputs.m` 可见，增量输出更新会额外查找：

1. `setOutputs(outputs)`（可选但强烈建议）

## 3. 参数组件如何接入主链路

关键位置：

1. `apps/MainApp.m` 的 `ensureParamComponent`
2. `apps/MainApp.m` 的 `resolveParamComponentClass`

接线逻辑：

1. `resolveParamComponentClass` 决定模板 ID 对应哪个组件类。
2. `ensureParamComponent` 创建组件并绑定监听：
   1. `PayloadChanged -> control.onParamsChanged`

所以你新增组件后，至少要保证：

1. 类名可被 `exist(<ClassName>, 'class')` 找到。
2. `PayloadChanged` 能正确触发。

## 4. 推荐的组件内部结构

参考现有组件，可保持以下结构稳定：

1. `Value`：公开参数结构体。
2. `defaultPayload()`：默认参数基线。
3. `collectPayloadFromUi(...)`：从控件读值。
4. `normalizePayload(...)`：组件内局部归一化。
5. `getPayload/setPayload`：统一入口。
6. `setOutputs`：运行态输出增量写回。

说明：

1. 组件内归一化是“局部友好处理”。
2. 最终合法性仍由 `params.validate` 兜底。

## 5. 新增一个参数组件的步骤（模板扩展常用）

假设你要新增 `M6_for_test.m`：

1. 新建文件 `m/M6_for_test.m`，类定义继承 `ComponentContainer`。
2. 实现最小接口：
   1. `getPayload`
   2. `setPayload`
   3. 事件 `PayloadChanged`
3. 建议补 `setOutputs`，避免播放时全量回写。
4. 在 `apps/MainApp.m` 的 `resolveParamComponentClass` 增加映射规则。
5. 在模板切换后，确认 `ensureParamComponent` 日志显示组件加载成功。

## 6. 参数字段如何做到“不丢失”

常见策略（参考现有组件）：

1. `getPayload` 读取 UI 后，基于旧 `Value` 合并未显示字段。
2. `setPayload` 先归一化再写控件，避免控件显示非法值。
3. 对输出字段（如 `epsilonOut`）不要和输入字段混在同一控件逻辑里。

## 7. 组件扩展中的常见坑

1. 只改控件，不改 `getPayload`，导致用户输入根本没进入参数链路。
2. 触发控件回写时没有重入保护，造成事件递归触发。
3. 忘记实现 `setOutputs`，播放时输出区不刷新或性能变差。
4. 组件默认值和 `schema_get` 默认值冲突，表现为“刚输入就被改回去”。

## 8. 组件层排查清单（出现“改参没反应”时）

1. `MainApp` 日志里是否有“参数组件加载成功”。
2. `PayloadChanged` 是否被绑定（`ensureParamComponent` 里会写日志）。
3. `getPayload` 返回值是否是 struct。
4. `onParamsChanged` 后 `app.Params` 是否变化。
5. `params.validate` 是否把字段回退（查看字段范围与类型定义）。

## 9. 新手练习

1. 在现有组件中新增一个只读输出字段，并通过 `setOutputs` 刷新它。
2. 给组件某个输入控件加范围保护，再验证 `params.validate` 仍能兜底。
3. 临时在 `getPayload` 里写一条日志，观察一次改参触发链路。

图示占位：

1. [占位] 参数组件生命周期图（创建/监听/改参/销毁）
2. [占位] `PayloadChanged` 到 `onParamsChanged` 时序图
