# UI渲染与日志排错

本文关注三块：

1. `src/+ui/`：参数与控件的数据桥。
2. `src/+viz/`：场景与曲线渲染。
3. `src/+logger/`：结构化日志与命令行输出策略。

快速跳转：

1. 上一页：`04_引擎与物理核扩展.md`
2. 下一页：`06_参数组件接口与新增组件流程.md`
3. 术语表：`GLOSSARY.md`

## 1. UI 数据桥（`src/+ui/`）

核心函数：

1. `buildPayload(app)`：从组件读取参数。
2. `applyPayload(app, p)`：把参数回写到组件。
3. `applyOutputs(app, outputs)`：只更新输出字段（增量）。
4. `render(app, state)`：调度 `viz.renderScene` 与 `viz.renderPlots`。

你可以把它理解为：

1. `buildPayload` 是“读”。
2. `applyPayload` 是“写全量”。
3. `applyOutputs` 是“写局部（高频）”。

## 2. 为什么有 `applyOutputs`

在播放时每帧都全量 `setPayload` 会带来 UI 抖动和额外开销。  
当前项目在 `onTick` 里走：

1. `mergeRailOutputs`
2. `ui.applyOutputs`
3. `ui.render`

这能减少每帧无关控件更新。

## 3. 场景渲染职责（`renderScene`）

文件：`src/+viz/renderScene.m`

职责范围：

1. 场景坐标轴更新
2. 轨迹、粒子、箭头渲染
3. 有界磁场标记与边框
4. 模板叠层（导轨、速度选择器、质谱仪）
5. 缓存图元句柄，减少重复创建

注意点：

1. 当前使用 `drawnow nocallbacks`，不是 `limitrate`。
2. 模型分支通过 `resolveModelType` 统一解析。

## 4. 曲线渲染职责（`renderPlots`）

文件：`src/+viz/renderPlots.m`

当前行为：

1. 仅对导轨模型绘制主曲线。
2. 对 `R1` 场景显示占位提示。
3. 历史数据缓存于 `plotsGrid.UserData.plotCache`。
4. 检测时间回退时会清空历史，避免残留。

## 5. 日志系统（`logger.logEvent`）

文件：`src/+logger/logEvent.m`

统一日志记录结构：

1. `ts`：时间
2. `level`：级别（信息/调试/警告/错误）
3. `event`：事件名
4. `payload`：结构化字段

命令行输出策略：

1. 默认输出日志。
2. 如果 `app.shouldEchoLogToConsole` 存在，按其策略控制（播放中压制信息/调试，保留警告/错误）。

## 6. 常见问题排查路径

### 6.1 现象：改参数后界面不更新

排查：

1. 参数组件是否触发 `PayloadChanged`（看 `MainApp.ensureParamComponent` 绑定监听）。
2. `control.onParamsChanged` 是否进入（看日志事件）。
3. `ui.applyPayload` 是否成功调用组件 `setPayload`。

### 6.2 现象：播放在跑，但输出区不变

排查：

1. `onTick` 是否执行 `mergeRailOutputs`。
2. 对应组件是否实现 `setOutputs`。
3. `applyOutputs` 是否找到了 `ParamComponent`。

### 6.3 现象：曲线不画或突然清空

排查：

1. 模型是否是 `rail`（`renderPlots` 非 `rail` 会显示占位信息）。
2. 是否处于 `R1` 场景（`driveEnabled=false` 时显示占位）。
3. 时间是否回退（重置/切模会触发历史清空）。

### 6.4 现象：场景卡顿或箭头闪烁

排查：

1. 是否误改了 `onTick` 子步参数。
2. 是否在高频路径里新增了全量 UI 写回。
3. 是否在 `renderScene` 中频繁创建新图元而非复用缓存句柄。

## 7. 如何扩展 UI 与渲染（安全方式）

### 7.1 新增一个输出字段到参数面板

步骤：

1. 引擎里产出该字段到 `state`。
2. `mergeRailOutputs` 写回到 `params.<xxxOut>`。
3. 对应 `m/*_for_test.m` 的 `setOutputs` 读取该字段并刷新控件。

### 7.2 新增一条曲线

步骤：

1. 在 `renderPlots` 的缓存结构加历史数组。
2. 在 `appendHistory` 追加数据。
3. 在绘制逻辑里新增 line 句柄与坐标更新。
4. 在重置/占位逻辑中同步清空。

### 7.3 新增场景叠层元素

步骤：

1. 在 `renderScene` 增加分支函数（建议独立小函数）。
2. 使用缓存句柄模式，不每帧新建对象。
3. 在非适用模型下显式隐藏该句柄。

## 8. 常见坑

1. 直接在控制层拼接 UI 细节，导致层次混乱。
2. 在渲染函数里抛未捕获异常，导致播放中断。
3. 输出字段命名不统一（`state` 与 `params` 不同名）导致输出区无值。
4. 新增图元后没有“隐藏分支”，切模板时残影残留。

## 9. 新手练习

1. 给日志 payload 新增一个字段并确认界面日志可读。
2. 在 `renderScene` 给某模型加一个临时文本标记，再练习按模型隐藏。
3. 观察 `applyPayload` 与 `applyOutputs` 在播放中的调用差异。

图示占位：

1. [占位] UI 数据桥三函数关系图（build/apply/applyOutputs）
2. [占位] 渲染缓存句柄生命周期图
