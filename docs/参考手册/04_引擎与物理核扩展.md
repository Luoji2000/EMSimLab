# 引擎与物理核扩展

本文聚焦两层：

1. `src/+engine/`：分发与状态管理。
2. `src/+physics/`：公式实现函数。

目标是让你知道“改哪里最安全”。

快速跳转：

1. 上一页：`03_控制层调用链与回调入口.md`
2. 下一页：`05_UI渲染与日志排错.md`
3. 术语表：`GLOSSARY.md`

## 1. 现有引擎分发结构

关键文件：

1. `src/+engine/reset.m`
2. `src/+engine/step.m`

当前模型分支：

1. `particle`
2. `selector`
3. `rail`

这三个分支都由 `modelType` 解析后进入 `switch` 分发。

参考片段（来自 `src/+engine/step.m`）：

```matlab
modelType = resolveModelType(params);
switch modelType
    case "rail"
        state = stepRailState(state, params, dt);
    case "selector"
        state = stepSelectorState(state, params, dt);
    otherwise
        state = stepParticleState(state, params, dt);
end
```

这段代码的意义：

1. `engine` 只管路由，不把所有公式挤在一个函数里。
2. 扩展新模型时，入口很清晰。

## 2. 状态字段的最小共识

常见基础字段（不同分支会增减）：

1. `t`：时间
2. `modelType`：模型类型
3. `x/y`：位置
4. `vx/vy`：速度
5. `traj`：轨迹缓存
6. `stepCount`：步计数
7. `inField`：是否在场内（有界场相关）
8. `mode`：当前子模式（如 `rail_bounded_inside`）

说明：

1. `reset` 负责创建这些字段。
2. `step` 负责稳定更新这些字段。

## 3. 物理核函数怎么挂到引擎

当前示例：

1. 粒子旋转推进：`src/+physics/rotmatStep2D.m`
2. 交叉场推进：`src/+physics/crossedFieldStep2D.m`
3. 导轨推进：`src/+physics/railAdvanceNoFriction.m`
4. 导轨输出：`src/+physics/railOutputsNoFriction.m`
5. 导轨焦耳热：`src/+physics/railHeatDeltaNoFriction.m`

建议规则：

1. 公式放 `physics`。
2. 分支调度放 `engine`。
3. 输出合并放 `control.mergeRailOutputs`。

## 4. 扩展路径A：只改现有模型公式（推荐优先）

适用：你想优化某个模型的推进公式，但不想加新 `modelType`。

步骤：

1. 在 `src/+physics/` 新增或替换核函数。
2. 在对应 `stepXxxState` 分支调用新核函数。
3. 保持 `state` 字段命名稳定。
4. 若新增输出，补 `mergeRailOutputs` 和组件 `setOutputs`。

优点：

1. 改动面小。
2. UI 和控制层通常不用大改。

## 5. 扩展路径B：新增 `modelType`（只在必要时）

步骤：

1. 模板层：`src/+templates/+defs/*.m` 设置新 `engineKey`。
2. 参数层：`src/+params/schema_get.m` 增加 schema。
3. 引擎层：
   1. `engine.reset` 新增 `resetXxxState`
   2. `engine.step` 新增 `stepXxxState`
4. 物理层：`src/+physics/` 新增核函数。
5. 渲染层：`src/+viz/renderScene.m` 新增可视化分支。
6. 输出层：`src/+control/mergeRailOutputs.m` 增加输出映射（若需要）。

## 6. 关于 `R2LC` 的当前定位

现状（仓库可见）：

1. 有模板定义：`src/+templates/+defs/R2LC.m`
2. 已在注册表中出现：`src/+templates/registry.m`

但当前手册主线不把它当作“已接通功能”：

1. `schema_get("rail")` 仍是电阻导轨参数。
2. `engine.step` 的 `rail` 分支仍基于现有导轨核函数。

## 7. 常见坑

1. 新增状态字段只在 `step` 写，`reset` 没初始化，首次渲染会异常。
2. 在 `engine` 里直接写大量绘图逻辑，破坏分层。
3. 在 `physics` 内偷偷读取 `app` 或 UI 句柄，导致函数难复用。
4. 改了 `modelType` 字符串但没同步 `resolveModelType`，会落入错误分支。

## 8. 新手练习

1. 在 `rail` 分支里新增一个调试输出字段（例如瞬时加速度），并确保不破坏现有渲染。
2. 把 `particle` 分支的某个常量提取成局部函数参数，观察可读性变化。
3. 追踪一次 `reset -> step -> render`，写下 `state` 字段变化表。

图示占位：

1. [占位] `engine` 与 `physics` 职责边界图
2. [占位] 新增 `modelType` 改动点清单图
