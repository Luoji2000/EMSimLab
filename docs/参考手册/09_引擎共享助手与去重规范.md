# 引擎共享助手与去重规范

本文说明在不引入重型类结构（`classdef`）前提下，如何通过 `engine.helpers` 做函数式去重，并保持代码可读、可维护、可回归。

## 1. 目标与边界

目标：
1. 保持 `src/+engine/step.m` 与 `src/+engine/reset.m` 作为流程主入口，阅读路径不打散。
2. 把重复且稳定的规则抽到 `src/+engine/+helpers/`，避免多处复制后漂移。
3. 不改变业务行为，不改变 UI 协作链路，不改变模板语义。

边界：
1. `helpers` 只放纯解析/纯挂载逻辑，不放推进主流程。
2. 物理公式真源仍在 `src/+physics/`，不要把公式搬进 `helpers`。

## 2. 当前已收敛的共享函数

1. `src/+engine/+helpers/attachR8Outputs.m`
2. `src/+engine/+helpers/isR8Template.m`
3. `src/+engine/+helpers/resolveRailElement.m`
4. `src/+engine/+helpers/resolveModelType.m`
5. `src/+engine/+helpers/attachRailOutputsCommon.m`

对应改动：
1. `src/+engine/step.m` 的同名本地函数改为薄封装委托。
2. `src/+engine/reset.m` 的同名本地函数改为薄封装委托。
3. `attachRailOutputs` 的 R/C/L + R8 挂载逻辑集中到 `attachRailOutputsCommon`，减少双份公式漂移风险。

## 3.1 渲染口径一致性（R8）

目标：
1. 渲染层几何与物理源输出保持同一口径。
2. 兼容旧状态结构，不破坏历史回放与旧脚本。

规则：
1. `renderScene` 的 R8 分支优先读取 `state.xFront/state.xBack`（来自 `frameStripOutputs`）。
2. 仅在上述字段缺失时，回退为“中心坐标 + 线框宽度”的几何推导。
3. 电流箭头方向按 `frameStripOutputs` 的 `current/epsilon` 符号口径渲染，保持“出屏磁场进入阶段右侧边向下”的教学可视化一致性。

## 4. 函数注释规范（统一模板）

适用范围：
1. 顶层函数。
2. 文件内局部函数。
3. 局部临时工具函数（如 `pickField` / `logicalField`）。

注释模板（建议顺序固定）：
```matlab
%FUNCTIONNAME  一句话用途
%
% 用途
%   - 说明这个函数负责什么。
%
% 输入
%   a (1,1) double
%     参数含义。
%
% 输出
%   b (1,1) double
%     返回值含义。
%
% 说明
%   - 关键规则、边界条件、委托关系、兼容性约束等。
```

约束：
1. 注释语言以中文为主，术语可中英并列。
2. 要写清用途、输入、输出、说明四段。
3. 文件编码统一 UTF-8。

## 5. 后续去重准则

满足任一条件可优先抽到 `engine.helpers`：
1. 同一逻辑在 `step/reset/peek` 出现 2 次及以上。
2. 逻辑不依赖图形句柄和 UI 控件。
3. 逻辑输入输出可用结构体与标量清晰表达。

不建议抽出的逻辑：
1. 强依赖流程上下文的一次性状态机。
2. 仅出现一次且可读性已经足够高的代码。

## 6. 回归建议

本类改动属于结构收敛、行为不变，最少回归：
1. `tests/smoke_r8_frameStripOutputs_formula.m`
2. `tests/smoke_r8_reset_step_semantics.m`
3. `tests/smoke_r8_validate_rules.m`
