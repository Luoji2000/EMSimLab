# R5 双导体棒模板接入说明

## 1. 目标与边界

1. R5 是独立模板，不并入 `R` 或 `R8`。
2. 保留当前“控制层/参数层/引擎层/渲染层”分层，不引入类化重构。
3. 首版优先打通可运行链路：模板切换、参数采集、reset/step、输出区、场景与曲线。

## 2. 模板与组件挂载

1. 模板定义：`src/+templates/+defs/R5.m`
2. 模板注册：`src/+templates/registry.m`
3. 模板预设：`src/+templates/applyTemplatePreset.m`（`applyR5Preset`）
4. 参数组件分配：`apps/MainApp.m`（`resolveParamComponentClass` 返回 `R5_for_test`）

## 3. 参数口径（R5）

1. A/B 双棒参数：
   - `LA/LB`、`xA0/xB0`、`vA0/vB0`
   - `RA/RB`、`mA/mB`、`FdriveA/FdriveB`
2. 公共参数：
   - `B/Bdir`、`bounded/xMin/xMax/yMin/yMax`
   - `rho`（恢复系数，范围 `[0,1]`）
   - `driveEnabled` 在 R5_V2 口径下固定为 `true`（不再作为 UI 选项）
3. 默认项（R5_V2）：
   - `showDriveForce=false`、`showAmpereForce=false`
   - `bounded=false`（默认无界）
4. 兼容字段（给通用链路兜底）：
   - `L=min(LA,LB)`、`R=RA+RB`
   - `x0=(xA0+xB0)/2`、`v0=(vA0+vB0)/2`

## 4. 物理真源与推进

1. 输出真源：`src/+physics/dualRodOutputs.m`
   - 统一输出 `mode(S0~S3)`、`overlap/dOverlap`
   - 合电动势/电流/电功率
   - `fMagA/fMagB/fMagSum`
2. 推进真源：`src/+physics/dualRodAdvance.m`
   - 解析段推进 + 事件定位
   - 事件类型：碰撞、边界切换
   - 热量口径：
     - `qHeatR`：焦耳热累计
     - `qHeatColl`：碰撞热累计
     - `qHeat=qHeatR+qHeatColl`

## 5. 引擎接入点

1. `src/+engine/reset.m`
   - 新增 `resetR5DualState`
2. `src/+engine/step.m`
   - 新增 `stepR5DualState`
3. `src/+engine/+helpers/isR5Template.m`
   - 统一模板判定入口

## 6. 输出与渲染

1. 输出汇总：`src/+control/mergeRailOutputs.m`
   - `xOut/vOut` 使用中心量
   - 新增 `qCollOut/xAOut/xBOut/vAOut/vBOut/modeOut`
2. 场景渲染：`src/+viz/renderScene.m`
   - R5 专用双棒同屏渲染分支（A/B 两根竖棒）
   - 按当前教学视觉约定，R5 场景不绘制左侧电阻符号
   - 右棒电流箭头按 R5 符号口径绘制，保证“B 离场阻碍离场”阶段可显示顺时针方向
3. 曲线渲染：`src/+viz/renderPlots.m`
   - 新增 `r5` 布局（3x2）
   - 同时显示 A/B/中心量、电学量、热量量
   - 曲线历史按 tick 持续累计（不依赖当前是否停留在“曲线”页签）

## 7. 参数组件接口约定（R5_for_test）

1. 必须提供：
   - `Value`
   - `getPayload()`
   - `setPayload(payload)`
   - `setOutputs(outputs)`
   - `PayloadChanged` 事件
2. A/B 单组输入框通过“导体选择下拉”切换编辑目标，内部写回 `A/B` 字段。

## 8. 当前已知限制

1. R5 曲线暂未加入模式背景色条（S0~S3 仍通过状态字段可读）。
2. `bounded=false` 时边界输入仍可编辑（按“除输出区外均可输入”规则保留输入权限）。
