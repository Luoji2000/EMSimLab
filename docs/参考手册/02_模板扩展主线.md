# 模板扩展主线（当前推荐）

本文是“从现有项目安全新增模板”的实操主线。  
你当前项目的最佳扩展路径是“模板扩展”，而不是一开始就扩引擎分支。

快速跳转：

1. 上一页：`01_工程导航与运行主线.md`
2. 下一页：`03_控制层调用链与回调入口.md`
3. 术语表：`GLOSSARY.md`

## 1. 先统一一个判断

新增模板前，先分两类：

1. 复用现有引擎：`engineKey` 仍是 `particle` / `selector` / `rail` 之一。  
适合“新教学场景，但计算模型与现有模型相同”。
2. 新增引擎分支：需要新的 `modelType` 和新的物理推进逻辑。  
适合“核心动力学方程不同”。

当前项目优先建议第 1 类，因为模板间存在较多重叠。

## 2. 复用现有引擎时的最小改动清单

按顺序执行：

1. 新建模板定义文件  
位置：`src/+templates/+defs/<ID>.m`  
要求字段：`id/title/group/engineKey/schemaKey`

2. 注册模板  
文件：`src/+templates/registry.m`  
动作：把 `templates.defs.<ID>()` 加入 `list`。

3. 模板预设（可选但常用）  
文件：`src/+templates/applyTemplatePreset.m`  
动作：为新模板设置默认参数（例如默认有界、默认显示开关）。

4. 参数定义  
文件：`src/+params/schema_get.m`  
动作：复用已有 `schemaKey` 或新增 schema。

5. 参数组件选择  
文件：`apps/MainApp.m` 的 `resolveParamComponentClass`  
动作：决定新模板使用哪个 `m/*_for_test.m` 组件。

6. 组件映射与联动（若需要新控件）  
文件：`m/*_for_test.m`  
动作：补 `defaultPayload/getPayload/setPayload`，必要时补 `setOutputs`。

7. 渲染与输出（可选）  
文件：`src/+viz/renderScene.m`、`src/+viz/renderPlots.m`、`src/+control/mergeRailOutputs.m`  
动作：只在需要新视觉元素或新曲线时修改。

## 3. 新增引擎分支时必须改的位置

如果你真的需要新增 `engineKey/modelType`：

1. `src/+engine/reset.m`：在 `resolveModelType` 与 `switch` 中增加重置分支。
2. `src/+engine/step.m`：在 `resolveModelType` 与 `switch` 中增加推进分支。
3. `src/+physics/*.m`：新增该分支物理核函数。
4. `src/+viz/renderScene.m`：增加场景渲染分支。
5. `src/+viz/renderPlots.m`：增加曲线渲染逻辑（可选）。
6. `src/+control/mergeRailOutputs.m`：若有新输出字段，补输出合并逻辑。

## 4. 模板重叠时怎么避免“复制粘贴膨胀”

推荐三条原则：

1. 模板差异优先放到 `applyTemplatePreset`，不要直接复制整套引擎逻辑。
2. 参数差异优先放到 `schema + validate`，不要在 UI 里散落临时校验。
3. 视觉差异优先放到 `viz` 的分支渲染或开关字段，不要新增一整套重复渲染函数。

## 5. 你当前仓库里的真实例子

1. `M4`：使用独立 `engineKey="selector"`，并在 `engine.reset/step` 接入 `selector` 分支。
2. `M5`：仍用 `engineKey="particle"`，通过 `applyTemplatePreset + params.validate` 固定质谱仪语义。
3. `R`：统一 `engineKey="rail"`，通过参数开关区分 R1/R2 场景行为。

对应文件：

1. `src/+templates/+defs/M4.m`
2. `src/+templates/+defs/M5.m`
3. `src/+templates/+defs/R.m`
4. `src/+templates/applyTemplatePreset.m`
5. `src/+params/validate.m`

## 6. 当前明确不做的内容

`R2LC` 暂不进入实现链路。  
说明：仓库里已有 `src/+templates/+defs/R2LC.m` 与注册项，但当前手册不把它作为已接通功能来写。

## 7. 扩展验收清单（不依赖烟雾测试）

你可以用手动操作做最小验收：

1. 启动后模板树能看到新模板。
2. 选中模板后，参数组件正确切换（或复用正确）。
3. 改一个关键参数，`onParamsChanged` 后界面和状态同步变化。
4. 点击运行，`onTick` 能持续推进且不报错。
5. 重置后状态回到初始值，曲线/轨迹不混入旧数据。

## 8. 常见坑

1. 只加 `+defs` 文件但忘记 `registry` 注册，模板树不会显示。
2. 模板用了新字段但 `schema_get` 没定义，`validate` 后字段会丢或回退。
3. 组件 `PayloadChanged` 没正确触发，改参后不会进入控制链路。
4. 改了 `modelType`，但 `engine.reset/step` 没有对应分支，会回退到错误分支。

## 9. 图示占位

1. [占位] 新增模板文件改动点分布图。
2. [占位] 模板切换时序图（TemplateTree -> onTemplateChanged -> reset -> render）。
