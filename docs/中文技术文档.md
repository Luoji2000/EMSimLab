# EMSimLab 中文技术文档

更新时间：2026-02-11  
适用范围：`F:/code/matlab/EMSimLab`

## 1. 项目目标

EMSimLab 是 ElectroSim 的重构迁移工程，目标是把原有“UI/控制/物理/渲染/日志”耦合逻辑拆成稳定分层，保证：

1. UI 层只负责显示与回调，不承载物理公式。
2. 控制层负责状态机、事件调度、模板切换。
3. 引擎层只负责物理步进，不操作 UI 句柄。
4. 可视化层只做渲染与句柄复用。
5. 日志层输出结构化事件，便于回放与排障。

## 2. 当前目录结构

```text
EMSimLab/
  EMSimLab.prj
  README.md
  run_dev.m
  .gitignore
  .gitattributes

  apps/
    MainApp.m

  apps_release/
    README_放置MainApp_mlapp.txt
    MainApp.mlapp (未来放置)

  src/
    +boot/
      startup.m
      projectRoot.m
      openReleaseApp.m
    +templates/
      registry.m
      getById.m
      +defs/
        M1.m
        M4.m
        M5.m
        R.m
    +params/
      schema_get.m
      defaults.m
      clamp.m
      validate.m
    +engine/
      reset.m
      step.m
      peek.m
    +control/
      onTemplateChanged.m
      onParamsChanged.m
      onPlay.m
      onPause.m
      onTick.m
      onReset.m
      parseTemplateId.m
    +ui/
      buildPayload.m
      applyPayload.m
      setPanelsForTemplate.m
      render.m
    +viz/
      renderScene.m
      renderPlots.m
    +logger/
      logEvent.m

  docs/
  tests/
  sandbox/
  logs/
  _legacy_root/
  _backups/
```

## 3. 模块职责定义

### 3.1 `apps/MainApp.m`

1. 只负责 App 组件声明和布局。
2. 回调只调用 `src/+control` 或 `src/+boot` 入口。
3. 不直接调用 `engine.*`，避免层间越权。

### 3.2 `src/+boot`

1. `startup(app)`：初始化模板、参数、状态，触发一次 UI 回写与渲染。
2. `projectRoot()`：统一计算工程根目录。
3. `openReleaseApp()`：打开 `apps_release/MainApp.mlapp`。

### 3.3 `src/+templates`

1. `+defs/*.m`：单模板定义文件（每个模板一个函数，当前已接入 `M1.m` 与统一 `R.m`）。
2. `registry()`：模板注册表汇总入口，只负责聚合 `+defs`。
3. `getById(id)`：根据模板 id 返回模板元数据，并给出可读错误提示；兼容 `R1/R2/R3/R4 -> R` 别名映射。

### 3.4 `src/+params`

1. `schema_get(schemaKey)`：返回参数定义。
2. `defaults(schema)`：按 schema 生成默认参数。
3. `validate(p,schema)`：参数合法化（补默认、限幅、规范化）。
4. `clamp(...)`：通用裁剪函数。

### 3.5 `src/+control`

1. `onTemplateChanged`：模板切换链路入口。
2. `onParamsChanged`：参数变化链路入口。
3. `onPlay/onReset`：运行与重置入口。
4. `parseTemplateId`：统一解析模板 id。

### 3.6 `src/+engine`

1. `reset`：重置物理状态。
2. `step`：按 `dt` 推进一步。
3. `peek`：可选状态摘要。

### 3.7 `src/+ui` 与 `src/+viz`

1. `ui.buildPayload`：UI -> params 映射。
2. `ui.applyPayload`：params -> UI 回写。
3. `ui.applyOutputs`：仅输出区增量回写（运行态性能优化入口）。
4. `ui.setPanelsForTemplate`：模板面板显示策略。
5. `ui.render`：渲染总入口。
6. `viz.renderScene/renderPlots`：拆分场景与曲线渲染。

### 3.8 `src/+logger`

1. `logEvent`：结构化日志输出。
2. 建议日志格式：`ts/level/event/payload`。

## 4. 运行时调用链

### 4.1 启动链

`MainApp` -> `boot.startup` -> `templates.getById` -> `params.schema_get/defaults/validate` -> `engine.reset` -> `ui.applyPayload` -> `ui.render`

### 4.2 参数变化链

UI 控件回调 -> `control.onParamsChanged` -> `ui.buildPayload` -> `params.validate` -> `ui.applyPayload` -> `engine.reset(或局部更新)` -> `ui.render`

### 4.3 模板切换链

模板树回调 -> `control.onTemplateChanged` -> `templates.getById` -> `params.defaults/validate` -> `ui.setPanelsForTemplate` -> `engine.reset` -> `ui.render`

### 4.4 播放链

`control.onPlay` -> `MainApp.startPlayback` -> `control.onTick` -> `engine.step` -> `ui.render`

## 5. 与 ElectroSim 的迁移映射

1. `ElectroSim/+Config/TemplateRegistry.m` -> `src/+templates/registry.m` + `src/+templates/+defs/*.m`
2. `ElectroSim/+Control/ParamSchema.m` -> `src/+params/schema_get.m`
3. `ElectroSim/+Engine/*Engine.m` -> `src/+engine/*.m`（按模板拆 dispatch）
4. `ElectroSim/+Services/*Controller.m` -> `src/+control/*.m`
5. `ElectroSim/+UI/Panel*` -> `src/+ui/*`
6. `ElectroSim/+Services/SceneEngineRenderer.m`、`PlotController.m` -> `src/+viz/*`
7. `ElectroSim/+Logger/*` -> `src/+logger/*`

## 6. 编码约束

1. 用户可见文本必须中文。
2. 不修改发布版 `.mlapp` 布局文件；开发期优先 `apps/MainApp.m`。
3. 场景与曲线统一 `uiaxes`，避免每帧 `cla`。
4. `speed` 仅影响仿真时间步，不直接改渲染帧率。
5. `Reset` 必须清空轨迹与曲线，并恢复默认速度。

### 6.1 注释规范（统一按 `schema_get` 风格）

1. 每个函数头必须包含：`输入`、`输出`、`行为/规则`（三者至少两项）。
2. 复杂函数必须解释“为什么这么做”，不仅写“做了什么”。
3. 注释以中文为主，字段名与代码标识保留英文原名。
4. 回调函数必须写明触发源与副作用（是否改状态、是否写日志）。
5. 参数归一化函数必须列出默认值、裁剪范围、联动规则。

### 6.2 UI 同步流程（`mlapp -> m/Version -> *_for_test.m`）

1. `.mlapp` 是可视化布局真源，结构调整优先在 App Designer 完成。
2. 每次导出 `.m` 后先存入 `m/Version/` 作为历史快照，不直接覆盖接入文件。
3. 接入运行链路的文件保持在 `m/*_for_test.m`，由控制层统一读取其 payload。
4. 未来替换父容器或新增控件时，优先保证对外接口不变，降低逻辑层改动范围。

## 7. 验收标准（第一阶段）

1. 可启动：`run('run_dev.m')` 后 App 正常显示。
2. 可切模板：模板树切换不报错，参数区可更新。
3. 可改参数：参数回写后 UI 与内部状态一致。
4. 可运行：`onPlay` 能推进状态，场景/曲线标题可变化。
5. 可重置：`onReset` 后状态回到初始。

### 7.1 当前 M1/M4/R 最小闭环状态（2026-02-11）

1. `apps/MainApp.m` 已接通模板树、参数组件与控制层回调。
2. 参数面板触发 `PayloadChanged` 后，会进入 `control.onParamsChanged` 完成参数归一化与渲染刷新。
3. 顶部速度控件值会写入 `params.speedScale`，并参与 `engine.step` 的步长缩放。
4. 可使用 `tests/smoke_m1_minimal_loop.m` 进行手动烟雾验证。
5. 单位联动已接通：
   - 选择“电子/质子”会自动切到“粒子单位(e, me)”；
   - 电子固定 `q=-1, m=1`，质子固定 `q=1, m=1836.15267343`；
   - 自定义在切入粒子模式时会重置为 `q=1, m=1`；
   - `q/m` 标签会在 `q(C)/m(kg)` 与 `q(e)/m(me)` 之间自动切换。
6. 无界旋转矩阵步进已接通：
   - `engine.step` 使用解析旋转矩阵更新 `v/x/y`，避免欧拉漂移；
   - `B=0` 时自动退化为匀速直线推进；
   - 场景页已支持大范围磁场标记与放大速度箭头（按速度与回旋半径对数缩放）。
7. 连续播放与自动跟随已接通：
   - `运行` 按钮进入定时播放，`暂停` 按钮停止定时播放；
   - `重置` 与 `模板切换` 会自动暂停播放，避免并发推进；
   - 参数新增 `autoFollow/followSpan/maxSpan`，可控制是否跟随粒子与视野尺度；
   - 跟随开启时，视角以粒子为中心自动收敛，便于观察运动细节。
8. 有界磁场链条已接通：
   - `bounded=true` 时，矩形区域内按旋转矩阵推进，区域外按匀速直线推进；
   - 支持粒子初始在磁场外的场景；
   - 单步发生进/出边界时，使用二分法定位穿越时刻后分段推进，实现“外 -> 内 -> 外”链条。
9. 有界磁场可视化已修正：
   - 有界模式下，磁场标记固定在整个有界方框内铺设，不随视窗裁剪；
   - 即使粒子离开有界区并拖拽坐标轴返回，方框内标记仍保持完整；
   - 有界区域使用黑色粗边框持续标识，便于区分有场/无场区域。
10. 通用边界函数已抽离：

   - 新增 `geom.readBoundsFromParams` 与 `geom.isInsideBounds`；
   - `engine.reset`、`engine.step`、`viz.renderScene` 统一复用，减少重复实现并为 R 系列预留扩展位。

11. R 系列统一模板已接入：
   - 模板定义使用 `src/+templates/+defs/R.m`；
   - `templates.getById` 兼容 `R1/R2/R3/R4 -> R` 的别名映射；
   - 参数 schema 使用 `rail`，覆盖导轨参数、显示开关与输出字段；
   - `MainApp.ensureParamComponent` 已按模板动态切换组件类（`R* -> R2_for_test`）。
12. R 引擎与场景已增强：
   - 引擎 `modelType=rail` 同时支持开路（`ε=BLv`）与闭路（`I=ε/R`）；
   - 安培力方向按楞次定律处理，始终阻碍导体棒当前运动方向；
   - 场景导轨分支已包含导轨、滑杆、电阻（矩形符号）与方向箭头。
13. R2 曲线页已接通：
   - 曲线页改为三子图：`v(t)`、`I(t)`、`F_mag(t)`；
   - R1（无外力）仅显示占位提示，R2（有外力）进入实时绘制；
   - 重置或时间回退时自动清空历史，避免曲线残留。
14. M5 质谱仪模板已接通（第一版）：
   - 模板注册新增 `src/+templates/+defs/M5.m`，并加入 `templates.registry`；
   - 参数组件新增 `m/M5_for_test.m`，支持统一接口 `Value/getPayload/setPayload/PayloadChanged`；
   - 场景渲染新增左侧粗线与小孔叠层，磁场仅在右半有界区域显示；
   - 参数约束新增 M5 专用规则：`xMin` 强制锁定 `specWallX`，防止左边界越过粗线。
15. 连续播放平滑化已接通（2026-02-10）：
   - `PlaybackPeriod` 默认从 `0.05s` 调整为 `1/30s`（30 FPS）；
   - `control.onTick` 改为“单帧子步进”推进，不再固定每帧只算一步；
   - 子步数量按“时间上限 + 角速度上限”自动估算，降低圆周轨迹跳点感；
   - 场景渲染去掉 `drawnow limitrate`，改为 `drawnow nocallbacks`，避免内部限帧造成卡顿；
   - 磁场标记新增缓存键机制，未变化时不重复重建点阵，减少渲染抖动。
16. 运行态性能优化 A+B 已接通（2026-02-11）：
   - 日志链路：`MainApp.appendLogLineImpl` 改为缓冲 + 节流刷新，日志页不可见时不频繁重绘；
   - 命令行链路：`logger.logEvent` 播放中抑制 `信息/调试` 输出，减少 `fprintf` 带来的 I/O 抖动；
   - 参数链路：`control.onTick/onReset/onPlay(on fallback)/onParamsChanged` 改为 `ui.applyOutputs` 增量回写输出区；
   - 参数组件：`R2_for_test`、`M5_for_test` 新增 `setOutputs` 接口，避免运行态每帧全量 `setPayload`。
17. M4 速度选择器已接通（2026-02-11）：
   - 模板定义新增 `src/+templates/+defs/M4.m`，参数 schema 新增 `selector`；
   - 参数组件新增 `m/M4_for_test.m`（统一 payload 接口，含单位/粒子联动）；
   - 引擎新增 `selector` 分支：场内走交叉场解析推进，场外走匀速直线，跨界使用二分定位；
   - 核心公式已抽离到 `src/+physics/crossedFieldStep2D.m`，采用“漂移速度 + 旋转矩阵 + 解析位移积分”；
   - 场景渲染新增 M4 叠层（极板与电场箭头）和分层受力箭头（电场力/磁场力/合力）；
   - 新增烟雾测试：`tests/smoke_m4_minimal_loop.m`。

## 7.2 连续播放平滑化机制（关键原理）

### A) 为什么会“看起来一顿一顿”

1. 若每帧只推进一次，且单步转角过大，轨迹会呈现离散折点。
2. `drawnow limitrate` 会主动限帧，视觉上会产生明显的“卡帧”。
3. 每帧重建大量图元（例如磁场点阵）会增加渲染抖动。

### B) 本项目采用的平滑化方案

1. **固定渲染节拍**：定时器按 `PlaybackPeriod=1/30s` 驱动 UI 刷新。
2. **子步进物理推进**：每个渲染帧内拆分为多个物理小步，累计到同一帧再渲染。
3. **角速度自适应拆分**：对粒子模型按  
   `nByAngle = ceil(|omega| * physFrameDt / maxAngle)`  
   自动增加子步，控制单子步转角不超过阈值。
4. **时间上限拆分**：按  
   `nByTime = ceil(physFrameDt / maxSubDt)`  
   控制每个子步时间上限，避免速度倍率高时步长过大。
5. **静态元素缓存**：磁场标记按“参数+视窗”生成缓存键，命中时只更新可见性，不重算点阵。

### C) `control.onTick` 当前默认参数（代码内常量）

1. `maxSubDt = 1/240`：单物理子步最大时间跨度。
2. `maxAngle = 0.12`（弧度）：单物理子步最大转角（约 6.9°）。
3. `maxSubSteps = 64`：单渲染帧最大拆分步数上限。
4. `speedScale`：会参与 `physFrameDt = frameDt * speedScale`，因此加速播放会自动触发更多子步。

### D) 调参建议（新手优先）

1. 如果仍觉得不够顺滑：先减小 `maxAngle`（例如 `0.10` 或 `0.08`）。
2. 如果 CPU 压力偏大：先增大 `maxSubDt`（例如 `1/200`）或降低 `maxSubSteps`。
3. 如果想更丝滑：可把 `PlaybackPeriod` 调到 `1/60`，但要观察 UI 负载。

## 8. 后续迁移顺序建议

1. 先迁 `templates + params`，建立参数字典。
2. 再迁 `engine`，做最小物理闭环。
3. 再迁 `control`，接通模板切换/参数变化/运行重置。
4. 最后迁 `ui + viz + logger`，完成显示与日志一致性。

## 9. 常见问题

1. 文档显示乱码：优先检查编辑器是否按 UTF-8 打开。
2. 调用命名冲突：确保 MATLAB path 只包含 `apps` 与 `src`，不要混入 `_legacy_root`。
3. 模板切换无效：检查 `templates.registry` 与 `control.parseTemplateId` 的 id 是否一致。
