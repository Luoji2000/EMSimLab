# EMSimLab 中文技术文档

更新时间：2026-02-07  
适用范围：`F:/code/matlab/EMSimLab`

## 1. 项目目标

EMSimLab 是 ElectroSim 的重构迁移工程，目标是把原有“UI/控制/物理/渲染/日志”耦合逻辑拆成稳定分层，保证：

1. UI 层只负责显示与回调，不承载物理公式。
2. 控制层负责状态机、事件调度、模板切换。
3. 引擎层只负责物理步进，不操作 UI 句柄。
4. 可视化层只做渲染与句柄复用。
5. 日志层输出结构化事件，便于回放与排障。

## 2. 当前目录结构

```text
EMSimLab/
  EMSimLab.prj
  README.md
  run_dev.m
  .gitignore
  .gitattributes

  apps/
    MainApp.m

  apps_release/
    README_放置MainApp_mlapp.txt
    MainApp.mlapp (未来放置)

  src/
    +boot/
      startup.m
      projectRoot.m
      openReleaseApp.m
    +handlers/
      onTick.m
    +templates/
      registry.m
      getById.m
    +params/
      schema_get.m
      defaults.m
      clamp.m
      validate.m
    +engine/
      reset.m
      step.m
      peek.m
    +control/
      onTemplateChanged.m
      onParamsChanged.m
      onPlay.m
      onReset.m
      parseTemplateId.m
    +ui/
      buildPayload.m
      applyPayload.m
      setPanelsForTemplate.m
      render.m
    +viz/
      renderScene.m
      renderPlots.m
    +logger/
      logEvent.m

  docs/
  tests/
  sandbox/
  logs/
  _legacy_root/
  _backups/
```

## 3. 模块职责定义

### 3.1 `apps/MainApp.m`

1. 只负责 App 组件声明和布局。
2. 回调只调用 `src/+control` 或 `src/+boot` 入口。
3. 不直接调用 `engine.*`，避免层间越权。

### 3.2 `src/+boot`

1. `startup(app)`：初始化模板、参数、状态，触发一次 UI 回写与渲染。
2. `projectRoot()`：统一计算工程根目录。
3. `openReleaseApp()`：打开 `apps_release/MainApp.mlapp`。

### 3.3 `src/+templates`

1. `registry()`：模板注册表，定义树结构、模板 id、引擎 key、schema key。
2. `getById(id)`：根据模板 id 返回模板元数据。

### 3.4 `src/+params`

1. `schema_get(schemaKey)`：返回参数定义。
2. `defaults(schema)`：按 schema 生成默认参数。
3. `validate(p,schema)`：参数合法化（补默认、限幅、规范化）。
4. `clamp(...)`：通用裁剪函数。

### 3.5 `src/+control`

1. `onTemplateChanged`：模板切换链路入口。
2. `onParamsChanged`：参数变化链路入口。
3. `onPlay/onReset`：运行与重置入口。
4. `parseTemplateId`：统一解析模板 id。

### 3.6 `src/+engine`

1. `reset`：重置物理状态。
2. `step`：按 `dt` 推进一步。
3. `peek`：可选状态摘要。

### 3.7 `src/+ui` 与 `src/+viz`

1. `ui.buildPayload`：UI -> params 映射。
2. `ui.applyPayload`：params -> UI 回写。
3. `ui.setPanelsForTemplate`：模板面板显示策略。
4. `ui.render`：渲染总入口。
5. `viz.renderScene/renderPlots`：拆分场景与曲线渲染。

### 3.8 `src/+logger`

1. `logEvent`：结构化日志输出。
2. 建议日志格式：`ts/level/event/payload`。

## 4. 运行时调用链

### 4.1 启动链

`MainApp` -> `boot.startup` -> `templates.getById` -> `params.schema_get/defaults/validate` -> `engine.reset` -> `ui.applyPayload` -> `ui.render`

### 4.2 参数变化链

UI 控件回调 -> `control.onParamsChanged` -> `ui.buildPayload` -> `params.validate` -> `ui.applyPayload` -> `engine.reset(或局部更新)` -> `ui.render`

### 4.3 模板切换链

模板树回调 -> `control.onTemplateChanged` -> `templates.getById` -> `params.defaults/validate` -> `ui.setPanelsForTemplate` -> `engine.reset` -> `ui.render`

### 4.4 播放链

`control.onPlay` / `handlers.onTick` -> `engine.step` -> `ui.render`

## 5. 与 ElectroSim 的迁移映射

1. `ElectroSim/+Config/TemplateRegistry.m` -> `src/+templates/registry.m`
2. `ElectroSim/+Control/ParamSchema.m` -> `src/+params/schema_get.m`
3. `ElectroSim/+Engine/*Engine.m` -> `src/+engine/*.m`（按模板拆 dispatch）
4. `ElectroSim/+Services/*Controller.m` -> `src/+control/*.m`
5. `ElectroSim/+UI/Panel*` -> `src/+ui/*`
6. `ElectroSim/+Services/SceneEngineRenderer.m`、`PlotController.m` -> `src/+viz/*`
7. `ElectroSim/+Logger/*` -> `src/+logger/*`

## 6. 编码约束

1. 用户可见文本必须中文。
2. 不修改发布版 `.mlapp` 布局文件；开发期优先 `apps/MainApp.m`。
3. 场景与曲线统一 `uiaxes`，避免每帧 `cla`。
4. `speed` 仅影响仿真时间步，不直接改渲染帧率。
5. `Reset` 必须清空轨迹与曲线，并恢复默认速度。

## 7. 验收标准（第一阶段）

1. 可启动：`run('run_dev.m')` 后 App 正常显示。
2. 可切模板：模板树切换不报错，参数区可更新。
3. 可改参数：参数回写后 UI 与内部状态一致。
4. 可运行：`onPlay` 能推进状态，场景/曲线标题可变化。
5. 可重置：`onReset` 后状态回到初始。

## 8. 后续迁移顺序建议

1. 先迁 `templates + params`，建立参数字典。
2. 再迁 `engine`，做最小物理闭环。
3. 再迁 `control`，接通模板切换/参数变化/运行重置。
4. 最后迁 `ui + viz + logger`，完成显示与日志一致性。

## 9. 常见问题

1. 文档显示乱码：优先检查编辑器是否按 UTF-8 打开。
2. 调用命名冲突：确保 MATLAB path 只包含 `apps` 与 `src`，不要混入 `_legacy_root`。
3. 模板切换无效：检查 `templates.registry` 与 `control.parseTemplateId` 的 id 是否一致。
